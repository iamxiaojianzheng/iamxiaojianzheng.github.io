<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"xiaojianzheng.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script><meta name="description" content="AbstractAppCommandpackage com.haigui.module.operation.service;import cn.hutool.core.io.FileUtil;import cn.hutool.core.io.IoUtil;import cn.hutool.core.net.NetUtil;import cn.hutool.core.util.ReUtil;impo"><meta property="og:type" content="article"><meta property="og:title" content="SSH-Java"><meta property="og:url" content="http://xiaojianzheng.cn/2022/09/22/SSH-Java/index.html"><meta property="og:site_name" content="JIAHE"><meta property="og:description" content="AbstractAppCommandpackage com.haigui.module.operation.service;import cn.hutool.core.io.FileUtil;import cn.hutool.core.io.IoUtil;import cn.hutool.core.net.NetUtil;import cn.hutool.core.util.ReUtil;impo"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-09-22T09:10:25.000Z"><meta property="article:modified_time" content="2022-09-22T09:10:25.000Z"><meta property="article:author" content="JIAHE"><meta property="article:tag" content="JIAHE"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://xiaojianzheng.cn/2022/09/22/SSH-Java/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://xiaojianzheng.cn/2022/09/22/SSH-Java/","path":"2022/09/22/SSH-Java/","title":"SSH-Java"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>SSH-Java | JIAHE</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">JIAHE</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-导航"><a href="/navigation/" rel="section"><i class="fa fa-location-arrow fa-fw"></i>导航</a></li><li class="menu-item menu-item-文档"><a href="/docs/" rel="section"><i class="fa fa-book fa-fw fa-fw"></i>文档</a></li><li class="menu-item menu-item-应用下载"><a href="/app-download/" rel="section"><i class="fas fa-download fa-fw fa-fw"></i>应用下载</a></li><li class="menu-item menu-item-cheat-sheet"><a href="/cheat-sheet/" rel="section"><i class="fas fa-pen fa-fw"></i>Cheat Sheet</a></li><li class="menu-item menu-item-软件安装部署"><a href="/software-install-and-deploy/" rel="section"><i class="fab fa-windows fa-fw"></i>软件安装部署</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#AbstractAppCommand"><span class="nav-number">1.</span> <span class="nav-text">AbstractAppCommand</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JschSessionPool"><span class="nav-number">2.</span> <span class="nav-text">JschSessionPool</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LinuxAppCommand"><span class="nav-number">3.</span> <span class="nav-text">LinuxAppCommand</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WindowsAppCommand"><span class="nav-number">4.</span> <span class="nav-text">WindowsAppCommand</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="JIAHE" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">JIAHE</p><div class="site-description" itemprop="description">Collection & Reuse</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">108</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://cook.aiurs.co/" title="https:&#x2F;&#x2F;cook.aiurs.co&#x2F;" rel="noopener" target="_blank">程序员做饭指南</a></li><li class="links-of-blogroll-item"> <a href="https://www.baidu.com/" title="https:&#x2F;&#x2F;www.baidu.com&#x2F;" rel="noopener" target="_blank">Baidu</a></li><li class="links-of-blogroll-item"> <a href="https://cn.bing.com/" title="https:&#x2F;&#x2F;cn.bing.com&#x2F;" rel="noopener" target="_blank">Bing</a></li><li class="links-of-blogroll-item"> <a href="https://www.google.com/" title="https:&#x2F;&#x2F;www.google.com&#x2F;" rel="noopener" target="_blank">Google</a></li><li class="links-of-blogroll-item"> <a href="https://zh.wikipedia.org/wiki/Wikipedia:%E9%A6%96%E9%A1%B5" title="https:&#x2F;&#x2F;zh.wikipedia.org&#x2F;wiki&#x2F;Wikipedia:%E9%A6%96%E9%A1%B5" rel="noopener" target="_blank">Wiki</a></li><li class="links-of-blogroll-item"> <a href="https://projectlombok.org/" title="https:&#x2F;&#x2F;projectlombok.org&#x2F;" rel="noopener" target="_blank">lombok</a></li><li class="links-of-blogroll-item"> <a href="https://logging.apache.org/log4j/2.x/" title="https:&#x2F;&#x2F;logging.apache.org&#x2F;log4j&#x2F;2.x&#x2F;" rel="noopener" target="_blank">log4j</a></li><li class="links-of-blogroll-item"> <a href="http://logback.qos.ch/" title="http:&#x2F;&#x2F;logback.qos.ch&#x2F;" rel="noopener" target="_blank">logback</a></li><li class="links-of-blogroll-item"> <a href="https://junit.org/junit5/" title="https:&#x2F;&#x2F;junit.org&#x2F;junit5&#x2F;" rel="noopener" target="_blank">junit</a></li><li class="links-of-blogroll-item"> <a href="https://element.eleme.cn/#/zh-CN" title="https:&#x2F;&#x2F;element.eleme.cn&#x2F;#&#x2F;zh-CN" rel="noopener" target="_blank">ElementUI</a></li><li class="links-of-blogroll-item"> <a href="https://zipkin.io/" title="https:&#x2F;&#x2F;zipkin.io&#x2F;" rel="noopener" target="_blank">Zipkin</a></li><li class="links-of-blogroll-item"> <a href="https://www.selenium.dev/zh-cn/" title="https:&#x2F;&#x2F;www.selenium.dev&#x2F;zh-cn&#x2F;" rel="noopener" target="_blank">Selenium</a></li><li class="links-of-blogroll-item"> <a href="https://nacos.io/zh-cn/docs/what-is-nacos.html" title="https:&#x2F;&#x2F;nacos.io&#x2F;zh-cn&#x2F;docs&#x2F;what-is-nacos.html" rel="noopener" target="_blank">Nacos</a></li><li class="links-of-blogroll-item"> <a href="https://dev.mysql.com/downloads/" title="https:&#x2F;&#x2F;dev.mysql.com&#x2F;downloads&#x2F;" rel="noopener" target="_blank">MySQL-Download</a></li><li class="links-of-blogroll-item"> <a href="https://redis.io/" title="https:&#x2F;&#x2F;redis.io&#x2F;" rel="noopener" target="_blank">Redis</a></li><li class="links-of-blogroll-item"> <a href="https://www.jetbrains.com/help/idea/discover-intellij-idea.html" title="https:&#x2F;&#x2F;www.jetbrains.com&#x2F;help&#x2F;idea&#x2F;discover-intellij-idea.html" rel="noopener" target="_blank">IDEA-Document</a></li><li class="links-of-blogroll-item"> <a href="https://jdk.java.net/" title="https:&#x2F;&#x2F;jdk.java.net&#x2F;" rel="noopener" target="_blank">JDK</a></li><li class="links-of-blogroll-item"> <a href="https://www.java.com/en/download/manual.jsp" title="https:&#x2F;&#x2F;www.java.com&#x2F;en&#x2F;download&#x2F;manual.jsp" rel="noopener" target="_blank">JDK8</a></li><li class="links-of-blogroll-item"> <a href="https://dev.java/" title="https:&#x2F;&#x2F;dev.java&#x2F;" rel="noopener" target="_blank">JAVA</a></li><li class="links-of-blogroll-item"> <a href="https://www.oracle.com/java/technologies/downloads/archive/" title="https:&#x2F;&#x2F;www.oracle.com&#x2F;java&#x2F;technologies&#x2F;downloads&#x2F;archive&#x2F;" rel="noopener" target="_blank">JDK-Oracle</a></li><li class="links-of-blogroll-item"> <a href="https://poi.apache.org/components/index.html" title="https:&#x2F;&#x2F;poi.apache.org&#x2F;components&#x2F;index.html" rel="noopener" target="_blank">POI</a></li><li class="links-of-blogroll-item"> <a href="https://assertj.github.io/doc/" title="https:&#x2F;&#x2F;assertj.github.io&#x2F;doc&#x2F;" rel="noopener" target="_blank">AssertJ</a></li><li class="links-of-blogroll-item"> <a href="https://docshome.gitbook.io/nginx-docs/" title="https:&#x2F;&#x2F;docshome.gitbook.io&#x2F;nginx-docs&#x2F;" rel="noopener" target="_blank">Nginx-CN</a></li><li class="links-of-blogroll-item"> <a href="https://github.com/cglib/cglib" title="https:&#x2F;&#x2F;github.com&#x2F;cglib&#x2F;cglib" rel="noopener" target="_blank">cglib</a></li><li class="links-of-blogroll-item"> <a href="https://docs.gitlab.com/ee/api/api_resources.html" title="https:&#x2F;&#x2F;docs.gitlab.com&#x2F;ee&#x2F;api&#x2F;api_resources.html" rel="noopener" target="_blank">Gitlab Api</a></li><li class="links-of-blogroll-item"> <a href="http://mockjs.com/examples.html" title="http:&#x2F;&#x2F;mockjs.com&#x2F;examples.html" rel="noopener" target="_blank">Mockjs Example</a></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://xiaojianzheng.cn/2022/09/22/SSH-Java/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="JIAHE"><meta itemprop="description" content="Collection & Reuse"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="JIAHE"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> SSH-Java</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-22 17:10:25" itemprop="dateCreated datePublished" datetime="2022-09-22T17:10:25+08:00">2022-09-22</time></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="AbstractAppCommand"><a href="#AbstractAppCommand" class="headerlink" title="AbstractAppCommand"></a>AbstractAppCommand</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.IoUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.net.NetUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ReUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RuntimeUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ftp.AbstractFtp;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.ChannelType;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.JschUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.Sftp;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.system.SystemUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.framework.askja.common.CommonUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.framework.askja.exception.BizException;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.AppConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.service.dto.PortDTO;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.*;</span><br><span class="line"><span class="keyword">import</span> com.profesorfalken.jpowershell.PowerShell;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAppCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String osType = SystemUtil.getOsInfo().isLinux() ? <span class="string">&quot;Linux&quot;</span> : <span class="string">&quot;Windows&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String localhost;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Charset charset = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> SshConfigDTO sshConfigDTO;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Sftp sftp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String powerShellExecutablePath = <span class="string">&quot;pwsh&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            localhost = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;获取IP地址异常, &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (osType.equals(<span class="string">&quot;Windows&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String path = Optional.ofNullable(RuntimeUtil.execForStr(<span class="string">&quot;which pwsh&quot;</span>)).orElse(<span class="string">&quot;&quot;</span>).trim();</span><br><span class="line">                <span class="keyword">if</span> (StrUtil.isNotBlank(path) &amp;&amp; FileUtil.exist(path)) &#123;</span><br><span class="line">                    powerShellExecutablePath = path;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SshConfigDTO <span class="title">getSshConfigDTO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sshConfigDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Function&lt;SshConfigDTO, String&gt; getCacheKey =</span><br><span class="line">            dto -&gt; StrUtil.format(<span class="string">&quot;&#123;&#125;@&#123;&#125;:&#123;&#125;:&#123;&#125;&quot;</span>, dto.getUsername(), dto.getHost(), dto.getPort(), dto.getConnectType());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractAppCommand</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sshConfigDTO = sshConfigDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractAppCommand <span class="title">getInstance</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sshConfigDTO.isLinux()) &#123;</span><br><span class="line">            <span class="keyword">return</span> LinuxAppCommand.getInstance(sshConfigDTO);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sshConfigDTO.isWindows()) &#123;</span><br><span class="line">            <span class="keyword">return</span> WindowsAppCommand.getInstance(sshConfigDTO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;不支持的：&#123;&#125;&quot;</span>, sshConfigDTO.getOsType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPidNumber</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(text)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(ReUtil.getGroup1(<span class="string">&quot;.*?(\\d+).*?&quot;</span>, text));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sftp <span class="title">getSftp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSftp(AbstractFtp.DEFAULT_CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sftp <span class="title">getSftp</span><span class="params">(Charset charset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sftp == <span class="keyword">null</span> || sftp.getClient().isClosed()) &#123;</span><br><span class="line">            sftp = <span class="keyword">new</span> Sftp(getChannelSftp(), charset);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!sftp.getClient().isConnected()) &#123;</span><br><span class="line">            sftp.reconnectIfTimeout();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sftp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeSftp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JschUtil.close(sftp.getClient());</span><br><span class="line">        sftp = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ChannelSftp <span class="title">getChannelSftp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JschUtil.openSftp(sshConfigDTO.getJschSession(), <span class="number">60000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            JschSessionPool.INSTANCE.close(sshConfigDTO);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InetSocketAddress address = NetUtil.createAddress(sshConfigDTO.getHost(), sshConfigDTO.getPort());</span><br><span class="line">        <span class="keyword">if</span> (!NetUtil.isOpen(address, <span class="number">3000</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;IP：&#123;&#125; Port: &#123;&#125; 无法连接&quot;</span>, sshConfigDTO.getHost(), sshConfigDTO.getPort() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (appExistLocalMachine()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sshConfigDTO.getJschSession().isConnected();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">buildExecuteCommands</span><span class="params">(String command)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================ 进程相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStartProcessCommand</span><span class="params">(AppConfigDTO appConfigDTO, SshConfigDTO sshConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildKillCommand</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildGetPortCommand</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildGetProcessMemoryCommand</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getServerFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getPidFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildGetPidCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStopServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildRestartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildTailFileCommand</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStopTailFileCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================ 进程相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================ 系统相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将路径列表中的所有文件打包为zip压缩包</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePathList 待压缩的路径集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> zip压缩包的路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">compressToZip</span><span class="params">(List&lt;String&gt; filePathList)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文件或文件夹的总计大小，单位 kb</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件或文件夹的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 总计大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文件的MD5值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> MD5值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getFileMd5</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppJarMd5</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appJarPath = appConfigDTO.getAppJarPath();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = getFile(appJarPath);</span><br><span class="line">        File tempFile = FileUtil.createTempFile(appConfigDTO.getAppName(), <span class="string">&quot;.jar&quot;</span>, <span class="keyword">new</span> File(<span class="string">&quot;.&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        FileUtil.writeBytes(bytes, tempFile);</span><br><span class="line">        <span class="keyword">try</span> (JarFile jarFile = <span class="keyword">new</span> JarFile(tempFile)) &#123;</span><br><span class="line">            JarEntry md5Entry = jarFile.getJarEntry(<span class="string">&quot;BOOT-INF/classes/MD5&quot;</span>);</span><br><span class="line">            String md5 = IoUtil.read(jarFile.getInputStream(md5Entry), StandardCharsets.UTF_8);</span><br><span class="line">            log.info(<span class="string">&quot;获取文件&#123;&#125;的MD5：&#123;&#125;&quot;</span>, appJarPath, md5);</span><br><span class="line">            <span class="keyword">return</span> md5;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            FileUtil.del(tempFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getMemoryUsedRateCommand</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMemoryUsedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = getMemoryUsedRateCommand();</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getCpuUsedRateCommand</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCpuUsedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = getCpuUsedRateCommand();</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getDiskUsedRateCommand</span><span class="params">(List&lt;String&gt; mountedDir)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDiskUsedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = getDiskUsedRateCommand(sshConfigDTO.getMountedDirList());</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================== 系统相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================== 文件相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getFileContent</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">writeFileContent</span><span class="params">(String content, String filePath, SshConfigDTO sshConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String sourcePath, String targetPath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(String sourcePath, String targetPath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">mkdir</span><span class="params">(String newDirPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSftp().mkdir(newDirPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">fileExist</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">deleteFile</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(String dirPath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 变更文件或目录的权限</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * /bin/chmod $&#123;params&#125; $&#123;filePath&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params   chmod命令后面的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">chmod</span><span class="params">(String filePath, String params)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChannelSftp.LsEntry&gt; listDir(String dirPath) &#123;</span><br><span class="line">        <span class="keyword">return</span> getSftp().lsEntries(dirPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索包含关键字的文件，类似find命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dirPath   基于搜索的目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyword   关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> recursive 是否递归搜索</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 匹配的所有文件绝对路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">listDir</span><span class="params">(String dirPath, String keyword, <span class="keyword">boolean</span> recursive)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkShellFileCanExecute</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        Sftp sftp = getSftp();</span><br><span class="line">        List&lt;ChannelSftp.LsEntry&gt; lsEntries = sftp.lsEntries(filePath);</span><br><span class="line">        <span class="keyword">if</span> (lsEntries.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ChannelSftp.LsEntry file = lsEntries.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> file.getAttrs().getPermissions() &gt; <span class="number">0</span>;</span><br><span class="line"><span class="comment">//        String command = String.format(&quot;ls -l %s | awk &#x27;&#123;print $1&#125;&#x27;&quot;, filePath);</span></span><br><span class="line"><span class="comment">//        // -rwxr-xr-x.</span></span><br><span class="line"><span class="comment">//        String result;</span></span><br><span class="line"><span class="comment">//        if (session == null) &#123;</span></span><br><span class="line"><span class="comment">//            result = exec(command, CharsetUtil.UTF_8);</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;</span></span><br><span class="line"><span class="comment">//            result = JschUtil.exec(session, command, CharsetUtil.UTF_8);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return result.charAt(3) == &#x27;x&#x27; &amp;&amp; result.charAt(6) == &#x27;x&#x27;;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopTailLog</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String command = buildStopTailFileCommand(appConfigDTO);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getTailLogInputStream</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String allLogPath = appConfigDTO.getAppAllLogPath();</span><br><span class="line">        String buildTailFileCommand = buildTailFileCommand(allLogPath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> exec(buildTailFileCommand);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;获取日志文件流失败&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;获取日志文件流失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFileBySsh</span><span class="params">(String sourcePath, String destPath, SftpProgressMonitor monitor, Sftp.Mode mode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// sftp上传只支持 /C:/qingting/lib 这样的路径</span></span><br><span class="line">        String source = (isWindowsPath(sourcePath) ? <span class="string">&quot;/&quot;</span> : <span class="string">&quot;&quot;</span>) + sourcePath;</span><br><span class="line">        String target = (isWindowsPath(destPath) ? <span class="string">&quot;/&quot;</span> : <span class="string">&quot;&quot;</span>) + destPath;</span><br><span class="line">        Sftp currentSftp = getSftp();</span><br><span class="line">        currentSftp.put(source, target, monitor, mode);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(String destPath, String fileName, InputStream fileStream, SftpProgressMonitor monitor, Sftp.Mode mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appExistLocalMachine()) &#123;</span><br><span class="line">            FileUtil.mkdir(destPath);</span><br><span class="line">            FileUtil.writeFromStream(fileStream, destPath + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// sftp上传只支持 /C:/qingting/lib 这样的路径</span></span><br><span class="line">            String dirPath = destPath;</span><br><span class="line">            <span class="keyword">if</span> (isWindowsPath(destPath)) &#123;</span><br><span class="line">                dirPath = <span class="string">&quot;/&quot;</span> + destPath;</span><br><span class="line">            &#125;</span><br><span class="line">            Sftp currentSftp = getSftp();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> currentSftp.upload(dirPath, fileName, fileStream);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    destPath = StrUtil.addSuffixIfNot(destPath, StrUtil.SLASH) + StrUtil.removePrefix(fileName, StrUtil.SLASH);</span><br><span class="line">                    currentSftp.put(fileStream, destPath, monitor, mode);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;上传文件失败, &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                closeSftp();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(String destPath, String fileName, InputStream fileStream, SftpProgressMonitor monitor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uploadFile(destPath, fileName, fileStream, monitor, Sftp.Mode.OVERWRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(String destPath, String fileName, InputStream fileStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uploadFile(destPath, fileName, fileStream, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(File uploadFile, String directory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uploadFile(directory, uploadFile.getName(), FileUtil.getInputStream(uploadFile));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(List&lt;File&gt; uploadFile, String directory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ChannelSftp channelSftp = getChannelSftp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channelSftp.mkdir(directory);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.debug(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channelSftp.cd(directory);</span><br><span class="line">            uploadFile.forEach(file -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> (InputStream in = FileUtil.getInputStream(file)) &#123;</span><br><span class="line">                    channelSftp.put(in, file.getName());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SftpException e) &#123;</span><br><span class="line">                    <span class="comment">// 指定上传路径不存在</span></span><br><span class="line">                    <span class="keyword">if</span> (ChannelSftp.SSH_FX_NO_SUCH_FILE == e.id) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;上传路径不存在&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.error(e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;上传Jar失败&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;上传&#123;&#125;至&#123;&#125;失败&quot;</span>, file.getAbsolutePath(), sshConfigDTO.getHost());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;上传Jar失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SftpException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;上传Jar失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JschUtil.close(channelSftp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getFile(String filePath) &#123;</span><br><span class="line">        Sftp sftp = getSftp();</span><br><span class="line">        <span class="keyword">try</span> (ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream()) &#123;</span><br><span class="line">            sftp.download(handleWindowsPathForSftp(filePath), outputStream);</span><br><span class="line">            <span class="keyword">return</span> outputStream.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;读取&#123;&#125;文件流失败&quot;</span>, filePath, e);</span><br><span class="line">            JschUtil.close(sftp.getClient());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;读取&#123;&#125;文件流失败&quot;</span>, filePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================== 文件相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================== 进程、服务相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String startServiceCommand = buildStartServiceCommand(appConfigDTO);</span><br><span class="line">        log.info(<span class="string">&quot;start command =&gt; &#123;&#125;&quot;</span>, startServiceCommand);</span><br><span class="line">        String result = execSystemCommand(startServiceCommand);</span><br><span class="line">        log.info(<span class="string">&quot;result =&gt; &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (pid &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;启动&#123;&#125;失败&quot;</span>, appConfigDTO.getAppName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String stopServiceCommand = buildStopServiceCommand(appConfigDTO);</span><br><span class="line">        log.info(<span class="string">&quot;stop command =&gt; &#123;&#125;&quot;</span>, stopServiceCommand);</span><br><span class="line">        String result = execSystemCommand(stopServiceCommand, <span class="keyword">null</span>);</span><br><span class="line">        log.info(<span class="string">&quot;result =&gt; &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String killCommand = buildKillCommand(pid);</span><br><span class="line">            execSystemCommand(killCommand);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;停止&#123;&#125;失败&quot;</span>, appConfigDTO.getAppName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restart</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String restartServiceCommand = buildRestartServiceCommand(appConfigDTO);</span><br><span class="line">        log.info(<span class="string">&quot;restart command =&gt; &#123;&#125;&quot;</span>, restartServiceCommand);</span><br><span class="line">        String result = execSystemCommand(restartServiceCommand, <span class="keyword">null</span>);</span><br><span class="line">        log.info(<span class="string">&quot;result =&gt; &#123;&#125;&quot;</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getPort</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> getPort(pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getPort</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line"></span><br><span class="line">        String getPortCommand = buildGetPortCommand(pid);</span><br><span class="line">        String result = execSystemCommand(getPortCommand);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(result)) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(result.split(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">                .peek(log::debug)</span><br><span class="line">                .map(text -&gt; ReUtil.getGroup1(<span class="string">&quot;.*?:(\\d+).*?&quot;</span>, text))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsedMemory</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String getMemoryCommand = buildGetProcessMemoryCommand(pid);</span><br><span class="line">            String result = execSystemCommand(getMemoryCommand);</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(result)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ReUtil.getGroup1(<span class="string">&quot;.*?([\\d,]+) ?K?$&quot;</span>, result).replace(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> StrUtil.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================ 进程、服务相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 start</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否启用防火墙</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">enableFirewall</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前开放端口列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;PortDTO&gt; <span class="title">listPorts</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">listRichRules</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开放端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">openPort</span><span class="params">(<span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开放端口给指定IP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">openPortToIp</span><span class="params">(String ip, <span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制IP访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">limitIp</span><span class="params">(String ip)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制端口访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">limitPort</span><span class="params">(<span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制指定IP访问端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">limitIpPort</span><span class="params">(String ip, <span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================ 基础方法 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execSystemCommand</span><span class="params">(List&lt;String&gt; commands)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exec(commands, charset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execSystemCommand</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command, charset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在指定文件夹下执行命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command 命令</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">execSystemCommand</span><span class="params">(String command, Charset charset)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; commands = buildExecuteCommands(command);</span><br><span class="line">        <span class="keyword">if</span> (appExistLocalMachine()) &#123;</span><br><span class="line">            <span class="keyword">return</span> exec(commands, charset);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> jschExec(String.join(<span class="string">&quot;\n;&quot;</span>, commands), charset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地执行命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmds 命令行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">exec</span><span class="params">(List&lt;String&gt; cmds, Charset charset)</span> </span>&#123;</span><br><span class="line">        String result;</span><br><span class="line">        log.debug(<span class="string">&quot;准备执行的命令：&#123;&#125;&quot;</span>, cmds);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sshConfigDTO.isWindows()) &#123;</span><br><span class="line">                <span class="keyword">try</span> (PowerShell powerShell = PowerShell.openSession(powerShellExecutablePath)) &#123;</span><br><span class="line">                    result = powerShell.executeCommand(String.join(<span class="string">&quot;\n&quot;</span>, cmds)).getCommandOutput();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Process process = <span class="keyword">new</span> ProcessBuilder(cmds).directory(<span class="keyword">null</span>).redirectErrorStream(<span class="keyword">true</span>).start();</span><br><span class="line">                result = RuntimeUtil.getResult(process, charset == <span class="keyword">null</span> ? CharsetUtil.UTF_8 : charset);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;执行结果：&#123;&#125;&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> cleanResult(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;exec 执行命令失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 远程执行命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd 命令行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">jschExec</span><span class="params">(String cmd, Charset charset)</span> </span>&#123;</span><br><span class="line">        Session jschSession = sshConfigDTO.getJschSession();</span><br><span class="line">        log.debug(<span class="string">&quot;准备执行的命令：&#123;&#125;&quot;</span>, cmd);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = JschUtil.exec(jschSession, cmd, charset == <span class="keyword">null</span> ? CharsetUtil.UTF_8 : charset);</span><br><span class="line">            log.debug(<span class="string">&quot;执行结果：&#123;&#125;&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> cleanResult(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">            sshConfigDTO.closeJschSession();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;jsch 执行命令失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InputStream <span class="title">exec</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Session jschSession = sshConfigDTO.getJschSession();</span><br><span class="line">        ChannelExec channel = (ChannelExec) JschUtil.createChannel(jschSession, ChannelType.EXEC);</span><br><span class="line">        channel.setCommand(cmd);</span><br><span class="line">        channel.setInputStream(<span class="keyword">null</span>);</span><br><span class="line">        channel.setErrStream(System.err);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream inputStream = channel.getInputStream();</span><br><span class="line">            channel.connect(<span class="number">6000</span>);</span><br><span class="line">            <span class="keyword">return</span> inputStream;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;获取结果流失败，&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;获取结果流失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">cleanResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> result.replaceAll(<span class="string">&quot;Active code page: 65001(\r\n)?&quot;</span>, <span class="string">&quot;&quot;</span>).trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用是否部署在当前设备上</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">appExistLocalMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sshConfigDTO.getHost().equals(localhost) &amp;&amp; osType.equals(sshConfigDTO.getOsType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isWindowsPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path.matches(<span class="string">&quot;^[A-Z]:[\\\\/].*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">handleWindowsPathForSftp</span><span class="params">(String windowsPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isWindowsPath(windowsPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/&quot;</span> + windowsPath.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> windowsPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================ 基础方法 end</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="JschSessionPool"><a href="#JschSessionPool" class="headerlink" title="JschSessionPool"></a>JschSessionPool</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.Assert;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.SimpleCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.SecureUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.JschRuntimeException;</span><br><span class="line"><span class="keyword">import</span> com.haigui.common.util.encrypt.EncryptUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.JSch;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.JSchException;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.Session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">JschSessionPool</span> </span>&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SSH会话池，key：host，value：Session对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleCache&lt;String, Session&gt; cache = <span class="keyword">new</span> SimpleCache&lt;&gt;(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Predicate&lt;Session&gt; checkConnect = session -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (session.isConnected()) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.connect(<span class="number">6000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSchException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Session，不存在返回null</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Session <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cache.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得一个SSH跳板机会话，重用已经使用的会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshHost 跳板机主机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshPort 跳板机端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshUser 跳板机用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshPass 跳板机密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SSH会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Session <span class="title">getSession</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String sshPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String key = getCacheKey(sshHost, sshPort, sshUser, sshPass, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cache.get(key, checkConnect,</span><br><span class="line">                () -&gt; openSession(sshHost, sshPort, sshUser, <span class="keyword">null</span>, sshPass, <span class="number">60000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得一个SSH跳板机会话，重用已经使用的会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshHost    跳板机主机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshPort    跳板机端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshUser    跳板机用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKey 跳板机私钥路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SSH会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Session <span class="title">getSession</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String privateKey, String sshPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String key = getCacheKey(sshHost, sshPort, sshUser, <span class="string">&quot;&quot;</span>, privateKey);</span><br><span class="line">        File tempFile = FileUtil.createTempFile(<span class="keyword">new</span> File(<span class="string">&quot;./temp&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtil.writeUtf8String(privateKey, tempFile);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.cache.get(key, checkConnect,</span><br><span class="line">                    () -&gt; openSession(sshHost, sshPort, sshUser, tempFile.getAbsolutePath(), sshPass, <span class="number">60000</span>));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            FileUtil.del(tempFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(SshConfigDTO dto)</span> </span>&#123;</span><br><span class="line">        String key = getCacheKey(dto.getHost(), dto.getPort(), dto.getUsername(), dto.getPassword(), dto.getPrivateKey());</span><br><span class="line">        close(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭SSH连接会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 主机，格式为user@host:port</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Session session = get(key);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span> &amp;&amp; session.isConnected()) &#123;</span><br><span class="line">            session.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.cache.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭所有SSH连接会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, Session&gt; entry : <span class="keyword">this</span>.cache) &#123;</span><br><span class="line">            session = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (session != <span class="keyword">null</span> &amp;&amp; session.isConnected()) &#123;</span><br><span class="line">                session.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cache.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getCacheKey</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String sshPass, String privateKeyPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SecureUtil.md5(StrUtil.format(<span class="string">&quot;&#123;&#125;@&#123;&#125;:&#123;&#125;&quot;</span>, sshUser, sshHost, sshPort, sshPass, privateKeyPath));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">openSession</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String privateKeyPath, String sshPass, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JSch jsch = <span class="keyword">new</span> JSch();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(privateKeyPath) &amp;&amp; StrUtil.isBlank(sshPass)) &#123;</span><br><span class="line">                jsch.addIdentity(privateKeyPath);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StrUtil.isNotBlank(privateKeyPath) &amp;&amp; StrUtil.isBlank(sshPass)) &#123;</span><br><span class="line">                jsch.addIdentity(privateKeyPath, sshPass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSchException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JschRuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createSession(jsch, sshHost, sshPort, sshUser, sshPass, timeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSchException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JschRuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">createSession</span><span class="params">(JSch jsch, String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String sshPass, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> JSchException </span>&#123;</span><br><span class="line">        Assert.notEmpty(sshHost, <span class="string">&quot;SSH Host must be not empty!&quot;</span>);</span><br><span class="line">        Assert.isTrue(sshPort &gt; <span class="number">0</span>, <span class="string">&quot;SSH port must be &gt; 0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认root用户</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(sshUser)) &#123;</span><br><span class="line">            sshUser = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == jsch) &#123;</span><br><span class="line">            jsch = <span class="keyword">new</span> JSch();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Session session = jsch.getSession(sshUser, sshHost, sshPort);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotEmpty(sshPass)) &#123;</span><br><span class="line">            session.setPassword(sshPass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置第一次登录的时候提示，可选值：(ask | yes | no)</span></span><br><span class="line">        session.setConfig(<span class="string">&quot;StrictHostKeyChecking&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br><span class="line">        session.setServerAliveCountMax(<span class="number">5</span>);</span><br><span class="line">        session.setServerAliveInterval(<span class="number">2000</span>);</span><br><span class="line">        session.connect(timeout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="LinuxAppCommand"><a href="#LinuxAppCommand" class="headerlink" title="LinuxAppCommand"></a>LinuxAppCommand</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.SimpleCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.text.CharSequenceUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.CharsetUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ReUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.framework.askja.exception.BizException;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.AppConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.service.dto.PortDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinuxAppCommand</span> <span class="keyword">extends</span> <span class="title">AbstractAppCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">&quot;sh&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = CharsetUtil.CHARSET_UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleCache&lt;String, LinuxAppCommand&gt; cache = <span class="keyword">new</span> SimpleCache&lt;&gt;(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinuxAppCommand <span class="title">getInstance</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        String cacheKey = getCacheKey.apply(sshConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> cache.get(cacheKey, () -&gt; <span class="keyword">new</span> LinuxAppCommand(sshConfigDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LinuxAppCommand</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(sshConfigDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">buildExecuteCommands</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不是所有命令都需要 /bin/bash -c</span></span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;source /etc/profile &amp;&amp; source ~/.bash_profile &amp;&amp; source ~/.bashrc;&quot;</span> + command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getServerFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;server.sh&quot;</span>);</span><br><span class="line">        String serverFilePath = serverPath.toString().replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> checkShellFileCanExecute = checkShellFileCanExecute(serverFilePath);</span><br><span class="line">        <span class="keyword">if</span> (!checkShellFileCanExecute) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;server.sh 不具备可执行权限！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serverFilePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getPidFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;shutdown.pid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverPath.toString().replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 构建命令 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartProcessCommand</span><span class="params">(AppConfigDTO appConfigDTO, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getServerFilePath(appConfigDTO) + <span class="string">&quot; start&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildKillCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;kill /pid &quot;</span> + pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetProcessMemoryCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 返回数值单位kb</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;cat /proc/&quot;</span> + pid + <span class="string">&quot;/smaps | grep &#x27;^Rss:&#x27; | awk &#x27;&#123;sum +=$2&#125; END&#123;print sum&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPortCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;netstat -anp | grep &#x27;LISTEN&#x27; | grep &#x27; &quot;</span> + pid + <span class="string">&quot;/&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPidCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            String serviceName = StrUtil.addSuffixIfNot(appConfigDTO.getServiceName(), <span class="string">&quot;.service&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;test -n \&quot;$(systemctl --state=running --type=service | grep %s)\&quot; &amp;&amp; systemctl status %s | grep &#x27;Main PID&#x27; | awk &#x27;&#123;print $3&#125;&#x27;&quot;</span>, serviceName, serviceName);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (appConfigDTO.isJavaDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;jps -vm | grep %s | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, appConfigDTO.getAppPath());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ps -ef | grep &#x27;&quot;</span> + appConfigDTO.getAppName() + <span class="string">&quot;&#x27; | grep -v &#x27;grep&#x27; | awk &#x27;&#123;print $2&#125;&#x27;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;systemctl start &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> buildStartProcessCommand(appConfigDTO, sshConfigDTO);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;systemctl stop &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; stop&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildRestartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;systemctl restart &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; restart&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildTailFileCommand</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tail -n 50 -f &quot;</span> + filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopTailFileCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ps -aux | grep -v grep | grep &#x27;&quot;</span> + buildTailFileCommand(appConfigDTO.getAppAllLogPath()) + <span class="string">&quot;&#x27; | awk &#x27;&#123;print $2&#125;&#x27; | xargs kill&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 进程、服务相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String pidFilePath = getPidFilePath(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (fileExist(pidFilePath)) &#123;</span><br><span class="line">            <span class="keyword">int</span> pid = Integer.parseInt(getFileContent(pidFilePath));</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtil.isNotEmpty(getPort(pid))) &#123;</span><br><span class="line">                <span class="keyword">return</span> pid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String buildGetPidCommand = buildGetPidCommand(appConfigDTO);</span><br><span class="line">        String result = execSystemCommand(buildGetPidCommand);</span><br><span class="line">        <span class="keyword">return</span> getPidNumber(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 系统相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">compressToZip</span><span class="params">(List&lt;String&gt; filePathList)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;name=&#x27;/tmp/&#x27;`cat /proc/sys/kernel/random/uuid` &amp;&amp; zip -qjr $name&#x27;.zip&#x27; &quot;</span> + String.join(<span class="string">&quot; &quot;</span>, filePathList) + <span class="string">&quot; &amp;&amp; echo $name&#x27;.zip&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;du -s &quot;</span> + filePath + <span class="string">&quot; | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(execSystemCommand(command));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFileMd5</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;test -f %s &amp;&amp; md5sum %s | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, filePath, filePath);</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMemoryUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 82.6577</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;cat /proc/meminfo | grep -E &#x27;^MemT|^MemF|^Buffers|^Cached&#x27; | awk -F&#x27; &#x27; &#x27;&#123;print $2&#125;&#x27; | awk &#x27;&#123;printf \&quot;%s \&quot;, $1&#125;&#x27; | awk &#x27;&#123;print ($1-$2-$3-$4)/$1*100&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getCpuUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 3.2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123; cat /proc/stat; sleep \&quot;1\&quot;; cat /proc/stat; &#125; | awk &#x27;/^cpu / &#123;usr=$2-usr; sys=$4-sys; idle=$5-idle; iow=$6-iow&#125; END &#123;total=usr+sys+idle+iow; printf (total-idle)/total*100&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDiskUsedRateCommand</span><span class="params">(List&lt;String&gt; mountedDir)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根目录挂载点 96.1242</span></span><br><span class="line">        String regex = mountedDir.stream().map(dir -&gt; dir + <span class="string">&quot;$&quot;</span>).collect(Collectors.joining(<span class="string">&quot;|&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;df | grep -E &#x27;&quot;</span> + regex + <span class="string">&quot;&#x27; | awk &#x27;BEGIN&#123;total=0;used=0&#125;&#123;total+=$2;used+=$3&#125;END &#123;print used/total*100&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFileContent</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        filePath = filePath.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        String command = <span class="string">&quot;cat &quot;</span> + filePath;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeFileContent</span><span class="params">(String content, String filePath, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        filePath = filePath.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        String command = <span class="string">&quot;echo &#x27;&quot;</span> + content.replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&#x27;\&quot;&#x27;\&quot;&#x27;&quot;</span>) + <span class="string">&quot;&#x27; &gt; &quot;</span> + filePath;</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// cp -fr /home/a/* /home/b</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;/bin/cp -fr %s %s&quot;</span>, sourcePath, targetPath);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> fileExist(targetPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// mv -f /home/a/* /home/b</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;/bin/mv -f %s %s&quot;</span>, sourcePath, targetPath);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> fileExist(targetPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fileExist</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;if [ -e &#x27;&quot;</span> + filePath + <span class="string">&quot;&#x27; ]; then echo 1; fi&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteFile</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;rm -f &quot;</span> + filePath;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.isBlank(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(String dirPath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;rm -rf &quot;</span> + dirPath;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.isBlank(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">chmod</span><span class="params">(String filePath, String params)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;/bin/chmod &quot;</span> + params + <span class="string">&quot; &quot;</span> + filePath;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.isBlank(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listDir</span><span class="params">(String dirPath, String keyword, <span class="keyword">boolean</span> recursive)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;find &#x27;%s&#x27; %s -name &#x27;*%s*&#x27;&quot;</span>, dirPath, recursive ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;-maxdepth 1&quot;</span>, keyword);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> CharSequenceUtil.splitTrim(result, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 start</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enableFirewall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --state&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;running&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PortDTO&gt; <span class="title">listPorts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 开放端口</span></span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --zone=public --list-ports | awk &#x27;BEGIN&#123;cmd=\&quot;\&quot;&#125;&#123;for(i=1;i&lt;=NF;i++) &#123;split($i,a,\&quot;/\&quot;); port=a[1]; protocol=a[2]; cmd=\&quot;netstat -tunlp | grep \&quot;port \&quot; | wc -l\&quot;; cmd | getline num; print a[1],a[2],num; &#125;&#125;&#x27;&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        List&lt;PortDTO&gt; list = StrUtil.splitTrim(result, <span class="string">&quot;\n&quot;</span>).stream().map(text -&gt; &#123;</span><br><span class="line">            String[] strings = text.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> port = Integer.parseInt(strings[<span class="number">0</span>]);</span><br><span class="line">            String protocol = strings[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">boolean</span> used = Integer.parseInt(strings[<span class="number">2</span>]) &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PortDTO(port, used, protocol);</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定ip开放端口</span></span><br><span class="line">        command = <span class="string">&quot;firewall-cmd --zone=public --list-rich-rules&quot;</span>;</span><br><span class="line">        result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(result)) &#123;</span><br><span class="line">            List&lt;PortDTO&gt; richRules = StrUtil.splitTrim(result, <span class="string">&quot;\n&quot;</span>).stream().map(text -&gt; &#123;</span><br><span class="line">                List&lt;String&gt; strings = ReUtil.getAllGroups(Pattern.compile(<span class="string">&quot;rule family=\&quot;ipv4\&quot; source address=\&quot;(.*?)\&quot; port port=\&quot;(.*?)\&quot; protocol=\&quot;(.*?)\&quot; accept&quot;</span>), text, <span class="keyword">false</span>);</span><br><span class="line">                String ip = strings.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> port = Integer.parseInt(strings.get(<span class="number">1</span>));</span><br><span class="line">                String protocol = strings.get(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">boolean</span> used = Integer.parseInt(strings.get(<span class="number">1</span>)) &gt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PortDTO(ip, port, used, protocol);</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            list.addAll(richRules);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listRichRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --zone=public --permanent --add-port=&quot;</span> + port + <span class="string">&quot;/tcp &amp;&amp; firewall-cmd --reload&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPortToIp</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=%s port protocol=tcp port=%s accept&#x27; &amp;&amp; firewall-cmd --reload&quot;</span>, ip, port);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=&quot;</span> + ip + <span class="string">&quot; reject&#x27;&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --zone=public --permanent --remove-port=&quot;</span> + port + <span class="string">&quot;/tcp &amp;&amp; firewall-cmd --reload&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIpPort</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;firewall-cmd --permanent --remove-rich-rule=&#x27;rule family=ipv4 source address=%s port protocol=tcp port=%s accept&#x27; &amp;&amp; firewall-cmd --reload&quot;</span>, ip, port);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 end</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="WindowsAppCommand"><a href="#WindowsAppCommand" class="headerlink" title="WindowsAppCommand"></a>WindowsAppCommand</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.SimpleCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.AppConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.service.dto.PortDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowsAppCommand</span> <span class="keyword">extends</span> <span class="title">AbstractAppCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">&quot;bat&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleCache&lt;String, WindowsAppCommand&gt; cache = <span class="keyword">new</span> SimpleCache&lt;&gt;(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WindowsAppCommand <span class="title">getInstance</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        String cacheKey = getCacheKey.apply(sshConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> cache.get(cacheKey, () -&gt; <span class="keyword">new</span> WindowsAppCommand(sshConfigDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WindowsAppCommand</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(sshConfigDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">buildExecuteCommands</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;chcp 65001;&quot;</span>, command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getServerFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;server.bat&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverPath.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getPidFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;shutdown.pid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverPath.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 构建命令 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartProcessCommand</span><span class="params">(AppConfigDTO appConfigDTO, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> serverFilePath + <span class="string">&quot; start&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildKillCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(</span><br><span class="line">                <span class="string">&quot;$ParentPid=((Get-CimInstance Win32_Process -Filter &#x27;ProcessId = %s&#x27;).ParentProcessId);&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if ($ParentPid) &#123; Stop-Process -Id $ParentPid; &#125;; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;$Process=(Get-Process -PID %s -ErrorAction SilentlyContinue); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if ($Process) &#123; Stop-Process -Id $Process.Id; &#125;&quot;</span>, pid, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetProcessMemoryCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 返回数值单位kb</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;((Get-Process -Id &quot;</span> + pid + <span class="string">&quot;).WorkingSet64 / 1024)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPortCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;netstat -nao -p tcp | findstr \&quot;LISTENING\&quot; | findstr &quot;</span> + pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPidCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appName = appConfigDTO.getAppName();</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isJavaDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;$cmds = @&#123;&#125;; Get-CimInstance Win32_Process | %&#123; $cmds[$_.ProcessId.ToString()] = $_.CommandLine; &#125;;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;(Get-Process | Where-Object &#123;$_.Name -eq &#x27;java&#x27;&#125; | Select-Object Id,@&#123;Name=&#x27;CommandLine&#x27;;Expression=&#123;$cmds[$_.Id.ToString()]&#125;&#125; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot; | Where-Object &#123;($_.CommandLine -notlike &#x27;*$cmds*&#x27;) -and ($_.CommandLine -match &#x27;&quot;</span> + appName + <span class="string">&quot;&#x27;)&#125;).Id&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;$cmds = @&#123;&#125;; Get-CimInstance Win32_Process | %&#123; $cmds[$_.ProcessId.ToString()] = $_.CommandLine; &#125;;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;(Get-Process | Select-Object Id,@&#123;Name=&#x27;CommandLine&#x27;;Expression=&#123;$cmds[$_.Id.ToString()]&#125;&#125; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot; | Where-Object &#123;($_.CommandLine -notlike &#x27;*$cmds*&#x27;) -and ($_.CommandLine -match &#x27;&quot;</span> + appName + <span class="string">&quot;&#x27;)&#125;).Id&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;net start &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> buildStartProcessCommand(appConfigDTO, sshConfigDTO);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;net stop &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; stop&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildRestartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            String serviceName = appConfigDTO.getServiceName();</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;net stop %s &amp;&amp; net start %s&quot;</span>, serviceName, serviceName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; restart&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildTailFileCommand</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;chcp 65001; Get-Content -Encoding utf8 -Path &quot;</span> + cleanPath(filePath) + <span class="string">&quot; -Tail 50 -Wait&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopTailFileCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Get-Process -Name pwsh | Where-Object &#123;$_.CommandLine -match &#x27;&quot;</span> + appConfigDTO.getAppAllLogPath() + <span class="string">&quot;&#x27;&#125; | Stop-Process&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 进程、服务相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String buildGetPidCommand = buildGetPidCommand(appConfigDTO);</span><br><span class="line">        String result = execSystemCommand(buildGetPidCommand);</span><br><span class="line">        <span class="keyword">return</span> getPidNumber(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 系统相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">compressToZip</span><span class="params">(List&lt;String&gt; filePathList)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// $uuid = (New-Guid).Guid; (Compress-Archive -Update -LiteralPath &#x27;%s&#x27; -DestinationPath &quot;~/$uuid.zip&quot; &amp;&amp; Resolve-Path &quot;~/$uuid.zip&quot;).Path</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;$uuid = (New-Guid).Guid; (Compress-Archive -Update -LiteralPath &#x27;%s&#x27; -DestinationPath \&quot;~/$uuid.zip\&quot; &amp;&amp; Resolve-Path \&quot;~/$uuid.zip\&quot;).Path&quot;</span>,</span><br><span class="line">                String.join(<span class="string">&quot;&#x27;, &#x27;&quot;</span>, cleanPath(filePathList)));</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// (Get-ChildItem -Path C:\qingting -Force -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum</span></span><br><span class="line">        String command = <span class="string">&quot;[int]((Get-ChildItem -Path &quot;</span> + cleanPath(filePath) + <span class="string">&quot; -Force -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum / 1024)&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(execSystemCommand(command));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFileMd5</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;(Get-FileHash &quot;</span> + cleanPath(filePath) + <span class="string">&quot; -Algorithm MD5).Hash&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMemoryUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 38.6184856473571</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;$mem = Get-CIMInstance Win32_OperatingSystem; ($mem.TotalVisibleMemorySize - $mem.FreePhysicalMemory) / $mem.TotalVisibleMemorySize * 100&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getCpuUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Get-CimInstance win32_processor | Measure-Object LoadPercentage -Average | ft -h Average&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDiskUsedRateCommand</span><span class="params">(List&lt;String&gt; mountedDir)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 29.2729359900061</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;powershell; $disk = Get-CimInstance win32_logicaldisk; ($disk.Size - $disk.FreeSpace) / $disk.Size * 100&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFileContent</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;Get-Content -Encoding utf8 -Path &#x27;&quot;</span> + cleanPath(filePath) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeFileContent</span><span class="params">(String content, String filePath, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        content = content.replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\&quot;\&quot;&quot;</span>);</span><br><span class="line">        String command = String.format(<span class="string">&quot;Set-Content -Encoding utf8 -Path &#x27;%s&#x27; -Value \&quot;%s\&quot;&quot;</span>, cleanPath(filePath), content);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Copy-Item -Recurse -Path &#x27;.\backup\1639120640510\*&#x27; -Destination &#x27;.\lib\&#x27;</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;Copy-Item -Recurse -Path &#x27;%s&#x27; -Destination &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(sourcePath), cleanPath(targetPath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;Move-Item -Path &#x27;%s&#x27; -Destination &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(sourcePath), cleanPath(targetPath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fileExist</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;Test-Path &#x27;&quot;</span> + cleanPath(filePath) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;True&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteFile</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;Remove-Item -Force -Path &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(filePath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(String dirPath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;Remove-Item -Force -Recurse -Path &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(dirPath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">chmod</span><span class="params">(String filePath, String params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listDir</span><span class="params">(String dirPath, String keyword, <span class="keyword">boolean</span> recursive)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// (Get-ChildItem -Recurse -Path . -Filter *pdf* -ErrorAction SilentlyContinue -Force | Resolve-Path -Relative | Resolve-Path).Path</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;(Get-ChildItem -Path &#x27;%s&#x27; -Filter *%s* -ErrorAction SilentlyContinue -Force %s | Resolve-Path -Relative | Resolve-Path).Path&quot;</span>,</span><br><span class="line">                cleanPath(dirPath), keyword, recursive ? <span class="string">&quot;-Relative&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.splitTrim(result, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 start</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enableFirewall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PortDTO&gt; <span class="title">listPorts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listRichRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPortToIp</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIpPort</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">cleanPath</span><span class="params">(List&lt;String&gt; paths)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paths.stream().map(path -&gt; StrUtil.removePrefix(path, <span class="string">&quot;/&quot;</span>)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">cleanPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StrUtil.removePrefix(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/2022/09/07/%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D%E4%BD%BF%E7%94%A8scoop/" rel="prev" title="重装系统后如何恢复使用scoop"><i class="fa fa-chevron-left"></i> 重装系统后如何恢复使用scoop</a></div><div class="post-nav-item"> <a href="/2022/09/24/MySQL-Explain/" rel="next" title="MySQL Explain">MySQL Explain<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">湘ICP备19011756号-1</a></div><div class="copyright"> &copy; 2021 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">JIAHE</span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.2.7/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"ignores":null,"url":"http://xiaojianzheng.cn/2022/09/22/SSH-Java/"}</script><script src="/js/third-party/quicklink.js"></script></body></html>