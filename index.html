<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"xiaojianzheng.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script><meta name="description" content="Collection &amp; Reuse"><meta property="og:type" content="website"><meta property="og:title" content="JIAHE"><meta property="og:url" content="http://xiaojianzheng.cn/index.html"><meta property="og:site_name" content="JIAHE"><meta property="og:description" content="Collection &amp; Reuse"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="JIAHE"><meta property="article:tag" content="JIAHE"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://xiaojianzheng.cn/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>JIAHE</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">JIAHE</h1><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-导航"><a href="/navigation/" rel="section"><i class="fa fa-location-arrow fa-fw"></i>导航</a></li><li class="menu-item menu-item-文档"><a href="/docs/" rel="section"><i class="fa fa-book fa-fw fa-fw"></i>文档</a></li><li class="menu-item menu-item-应用下载"><a href="/app-download/" rel="section"><i class="fas fa-download fa-fw fa-fw"></i>应用下载</a></li><li class="menu-item menu-item-cheat-sheet"><a href="/cheat-sheet/" rel="section"><i class="fas fa-pen fa-fw"></i>Cheat Sheet</a></li><li class="menu-item menu-item-软件安装部署"><a href="/software-install-and-deploy/" rel="section"><i class="fab fa-windows fa-fw"></i>软件安装部署</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="JIAHE" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">JIAHE</p><div class="site-description" itemprop="description">Collection & Reuse</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">99</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">97</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://cook.aiurs.co/" title="https:&#x2F;&#x2F;cook.aiurs.co&#x2F;" rel="noopener" target="_blank">程序员做饭指南</a></li><li class="links-of-blogroll-item"> <a href="https://www.baidu.com/" title="https:&#x2F;&#x2F;www.baidu.com&#x2F;" rel="noopener" target="_blank">Baidu</a></li><li class="links-of-blogroll-item"> <a href="https://cn.bing.com/" title="https:&#x2F;&#x2F;cn.bing.com&#x2F;" rel="noopener" target="_blank">Bing</a></li><li class="links-of-blogroll-item"> <a href="https://www.google.com/" title="https:&#x2F;&#x2F;www.google.com&#x2F;" rel="noopener" target="_blank">Google</a></li><li class="links-of-blogroll-item"> <a href="https://zh.wikipedia.org/wiki/Wikipedia:%E9%A6%96%E9%A1%B5" title="https:&#x2F;&#x2F;zh.wikipedia.org&#x2F;wiki&#x2F;Wikipedia:%E9%A6%96%E9%A1%B5" rel="noopener" target="_blank">Wiki</a></li><li class="links-of-blogroll-item"> <a href="https://projectlombok.org/" title="https:&#x2F;&#x2F;projectlombok.org&#x2F;" rel="noopener" target="_blank">lombok</a></li><li class="links-of-blogroll-item"> <a href="https://logging.apache.org/log4j/2.x/" title="https:&#x2F;&#x2F;logging.apache.org&#x2F;log4j&#x2F;2.x&#x2F;" rel="noopener" target="_blank">log4j</a></li><li class="links-of-blogroll-item"> <a href="http://logback.qos.ch/" title="http:&#x2F;&#x2F;logback.qos.ch&#x2F;" rel="noopener" target="_blank">logback</a></li><li class="links-of-blogroll-item"> <a href="https://junit.org/junit5/" title="https:&#x2F;&#x2F;junit.org&#x2F;junit5&#x2F;" rel="noopener" target="_blank">junit</a></li><li class="links-of-blogroll-item"> <a href="https://element.eleme.cn/#/zh-CN" title="https:&#x2F;&#x2F;element.eleme.cn&#x2F;#&#x2F;zh-CN" rel="noopener" target="_blank">ElementUI</a></li><li class="links-of-blogroll-item"> <a href="https://zipkin.io/" title="https:&#x2F;&#x2F;zipkin.io&#x2F;" rel="noopener" target="_blank">Zipkin</a></li><li class="links-of-blogroll-item"> <a href="https://www.selenium.dev/zh-cn/" title="https:&#x2F;&#x2F;www.selenium.dev&#x2F;zh-cn&#x2F;" rel="noopener" target="_blank">Selenium</a></li><li class="links-of-blogroll-item"> <a href="https://nacos.io/zh-cn/docs/what-is-nacos.html" title="https:&#x2F;&#x2F;nacos.io&#x2F;zh-cn&#x2F;docs&#x2F;what-is-nacos.html" rel="noopener" target="_blank">Nacos</a></li><li class="links-of-blogroll-item"> <a href="https://dev.mysql.com/downloads/" title="https:&#x2F;&#x2F;dev.mysql.com&#x2F;downloads&#x2F;" rel="noopener" target="_blank">MySQL-Download</a></li><li class="links-of-blogroll-item"> <a href="https://redis.io/" title="https:&#x2F;&#x2F;redis.io&#x2F;" rel="noopener" target="_blank">Redis</a></li><li class="links-of-blogroll-item"> <a href="https://www.jetbrains.com/help/idea/discover-intellij-idea.html" title="https:&#x2F;&#x2F;www.jetbrains.com&#x2F;help&#x2F;idea&#x2F;discover-intellij-idea.html" rel="noopener" target="_blank">IDEA-Document</a></li><li class="links-of-blogroll-item"> <a href="https://jdk.java.net/" title="https:&#x2F;&#x2F;jdk.java.net&#x2F;" rel="noopener" target="_blank">JDK</a></li><li class="links-of-blogroll-item"> <a href="https://www.java.com/en/download/manual.jsp" title="https:&#x2F;&#x2F;www.java.com&#x2F;en&#x2F;download&#x2F;manual.jsp" rel="noopener" target="_blank">JDK8</a></li><li class="links-of-blogroll-item"> <a href="https://dev.java/" title="https:&#x2F;&#x2F;dev.java&#x2F;" rel="noopener" target="_blank">JAVA</a></li><li class="links-of-blogroll-item"> <a href="https://www.oracle.com/java/technologies/downloads/archive/" title="https:&#x2F;&#x2F;www.oracle.com&#x2F;java&#x2F;technologies&#x2F;downloads&#x2F;archive&#x2F;" rel="noopener" target="_blank">JDK-Oracle</a></li><li class="links-of-blogroll-item"> <a href="https://poi.apache.org/components/index.html" title="https:&#x2F;&#x2F;poi.apache.org&#x2F;components&#x2F;index.html" rel="noopener" target="_blank">POI</a></li><li class="links-of-blogroll-item"> <a href="https://assertj.github.io/doc/" title="https:&#x2F;&#x2F;assertj.github.io&#x2F;doc&#x2F;" rel="noopener" target="_blank">AssertJ</a></li><li class="links-of-blogroll-item"> <a href="https://docshome.gitbook.io/nginx-docs/" title="https:&#x2F;&#x2F;docshome.gitbook.io&#x2F;nginx-docs&#x2F;" rel="noopener" target="_blank">Nginx-CN</a></li><li class="links-of-blogroll-item"> <a href="https://github.com/cglib/cglib" title="https:&#x2F;&#x2F;github.com&#x2F;cglib&#x2F;cglib" rel="noopener" target="_blank">cglib</a></li><li class="links-of-blogroll-item"> <a href="https://docs.gitlab.com/ee/api/api_resources.html" title="https:&#x2F;&#x2F;docs.gitlab.com&#x2F;ee&#x2F;api&#x2F;api_resources.html" rel="noopener" target="_blank">Gitlab Api</a></li><li class="links-of-blogroll-item"> <a href="http://mockjs.com/examples.html" title="http:&#x2F;&#x2F;mockjs.com&#x2F;examples.html" rel="noopener" target="_blank">Mockjs Example</a></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang=""><link itemprop="mainEntityOfPage" href="http://xiaojianzheng.cn/2023/01/09/MySQL%E4%BD%BF%E7%94%A8LOAD-DATA-INFILE%E5%AF%BC%E5%85%A5%E5%A4%A7%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="JIAHE"><meta itemprop="description" content="Collection & Reuse"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="JIAHE"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2023/01/09/MySQL%E4%BD%BF%E7%94%A8LOAD-DATA-INFILE%E5%AF%BC%E5%85%A5%E5%A4%A7%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">MySQL使用LOAD DATA INFILE导入大批量数据</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-01-09 09:29:10" itemprop="dateCreated datePublished" datetime="2023-01-09T09:29:10+08:00">2023-01-09</time></span></div></div></header><div class="post-body" itemprop="articleBody"><p>导入大量带有时间格式的数据</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">load data <span class="keyword">local</span> infile <span class="string">&#x27;csv文件本地路径&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> 表名称</span><br><span class="line"><span class="comment">-- 每个字段值之间由&#x27;\t&#x27;隔开</span></span><br><span class="line">fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line"><span class="comment">-- 如果字段值由双引号包裹，则添加下面一行</span></span><br><span class="line">optionally enclosed <span class="keyword">by</span> <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line"><span class="comment">-- 每行之间的换行符为&#x27;\n&#x27;</span></span><br><span class="line">lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="comment">-- 如果第一行为字段名，则可以忽略</span></span><br><span class="line">ignore <span class="number">1</span> lines</span><br><span class="line"><span class="comment">-- 以下为表中所有字段值，按表结构顺序填写</span></span><br><span class="line">(id, <span class="variable">@gmt</span>_create, ...)</span><br><span class="line"><span class="comment">-- 转换日期字符串为MySQL日期类型</span></span><br><span class="line"><span class="keyword">set</span> gmt_create<span class="operator">=</span>SET_TO_DATE(<span class="variable">@gmt</span>_create, <span class="string">&#x27;csv中日期格式&#x27;</span>)</span><br></pre></td></tr></table></figure><p>MySQL日期格式参考: <a href="/docs/database/sql-syntax.html#%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96">日期格式化</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang=""><link itemprop="mainEntityOfPage" href="http://xiaojianzheng.cn/2022/09/25/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="JIAHE"><meta itemprop="description" content="Collection & Reuse"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="JIAHE"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/09/25/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="post-title-link" itemprop="url">分布式最佳实践：分布式锁</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-25 09:11:46" itemprop="dateCreated datePublished" datetime="2022-09-25T09:11:46+08:00">2022-09-25</time></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="为什么"><a href="#为什么" class="headerlink" title="为什么"></a>为什么</h2><p>在传统的单体服务中，我们经常会遇到多线程对于单一资源的抢占导致的线程安全问题以及对数据库数据操作的一致性问题，如果是在单体系统中，我们可以很方便的使用编程语言提供的锁以及数据库事务来解决这些问题。</p><p>一旦单体系统转为分布式架构，那么本地事务和线程锁就无法满足跨进程的锁效果；分布式锁则是用于进程间同步访问共享资源的一种方式，通过全局共享来实现全局锁的效果，保证数据的一致性。</p><p>总的来说，<strong>在分布式系统中，当我们期望一个操作（一个请求、一个方法、一个数据库操作...）在整个系统中同一时间只能有一个线程执行，那我们就需要用到分布式锁；</strong> 抽象来看就是两个场景：</p><ul><li>单一资源的数据变更：比如对共享存储数据（数据库、缓存...）进行修改，多线程的互斥</li><li>access token：对于多个资源的原子性操作，期望整个业务逻辑就是单一线程执行保持一致性，在入口处就锁住</li></ul><p>分布式锁应该具备的特性：</p><ul><li>原子性：在分布式系统中，一个方法在同一时间只能被一个线程执行</li><li>阻塞性：在没获取到锁时可以进行阻塞也可以返回失败</li><li>高可用：能够正确的获取锁和释放锁，且具备锁失效的能力</li><li>高性能：获取锁与释放锁的性能保障</li><li>可重入：能够具备可重入特性</li></ul><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><h3 id="基于数据库实现"><a href="#基于数据库实现" class="headerlink" title="基于数据库实现"></a>基于数据库实现</h3><h3 id="乐观锁实现"><a href="#乐观锁实现" class="headerlink" title="乐观锁实现"></a>乐观锁实现</h3><p>先去干，能不能干，能不能干成先不管，这就是乐观心态。在开发过程中，乐观锁用的非常多，比如典型的 CAS ；在不加锁的情况下保证数据的一致性。</p><p>使用方式也很简单，只需要在表中添加一个版本号的字段，每次对数据进行修改的时候，通过版本来确定是否能够更新 <code>update xx set version = OLD_VERSION+1 where id = ID and version = OLD_VERSION</code> , 如果更新不成功，客户端可以选择是否重试。当然，需要加上索引。</p><p>可见这种方式的优势其实很明显，不加锁，使用简单。但也有一些局限性</p><ul><li>只能支持单数据更新的一致性（对于数据的插入可以通过唯一索引来解决</li><li>由于是乐观锁（先干，在检查），也就意味着可能活干完咯，发现更新不了，浪费了计算资源</li><li>无法支持 access token</li></ul><h3 id="悲观锁实现"><a href="#悲观锁实现" class="headerlink" title="悲观锁实现"></a>悲观锁实现</h3><p>先自我审查自己能不能干，能不能干成，如果答案是no，那么就等着(阻塞)或先溜(返回)，这就是悲观心态。悲观锁在 access token 模式更加适用。</p><p>使用方式同样很好理解（这只是基于数据库的悲观锁的一种实现方式）</p><ol><li>有一张 <strong>资源锁</strong> 表，表中包含 <strong>锁</strong> 字段，并需要加上唯一索引</li><li>当有线程想要获取某个锁时，只需要在 <strong>资源锁</strong> 表中插入一条数据</li><li>如果插入成功，表示获取锁成功，插入失败则表示锁已经被占用</li><li>业务执行完释放锁，删除对应的锁记录即可</li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 1. 创建资源锁表</span><br><span class="line">CREATE TABLE &#96;resource_lock&#96; (</span><br><span class="line">  &#96;id&#96; int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,</span><br><span class="line">  &#96;lock_name&#96; varchar(64) NOT NULL COMMENT &#39;锁名&#39;,</span><br><span class="line">  &#96;update_time&#96; timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uidx_method_name&#96; (&#96;lock_name&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;2. 获取锁（插入成本表示获取到锁</span><br><span class="line">INSERT INTO resource_lock (lock_name) VALUES (&#39;lockName&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;3. 释放锁</span><br><span class="line">delete from resource_lock where lock_name &#x3D;&#39;lockName&#39;;</span><br></pre></td></tr></table></figure><p>乍一看好像很简单，如果程序一直保证正确执行，这种方式好像也行，但没如果... 对于一个分布式系统，服务宕机是会出现的，所以还需要考虑一些新的可能发生的问题</p><ul><li>没有失效机制：持有锁的线程所在的服务宕机了，还没来的及释放锁怎么办？ 可以通过在表中新增过期时间，写一个定时任务定期删除过期锁</li><li>不可重入：需要在表中新增线程信息，重入的时候先查询是否存在锁</li><li>不支持锁阻塞：需要编写相应的逻辑</li><li>基于数据库实现，那么数据库的可用性就需要得到保证，而且在并发大的时候，对于数据库的性能的影响问题</li></ul><p>这么一分析...为了确保悲观锁的功能完整性，实现也会越来越复杂...以至于既然要用存储去实现，为撒不直接用缓存，性能至少有保障。</p><h3 id="基于Redis-：AP架构"><a href="#基于Redis-：AP架构" class="headerlink" title="基于Redis ：AP架构"></a>基于Redis ：AP架构</h3><p>既然想到存储用缓存来做，那必然想到的第一个就是 Redis 了，Redis 也很给力，可以很好的支撑分布式锁的能力，提供了比较好用的命令</p><ul><li><code>setnx</code>: 当且仅当 key 不存在，将 key 的值设为 value ，并返回1；若给定的 key 已经存在，则 SETNX 不做任何动作，并返回0。</li><li><code>expire</code>: 为key设置一个超时时间，单位为second，超过这个时间锁会自动释放，避免死锁。</li></ul><p>大致的流程如下图</p><p><img data-src="https://pic1.zhimg.com/80/v2-e3fc985099d4a5afc7a52a30300dd288_720w.jpg" alt="img"></p><ol><li>client A 和 client B 同时执行 <code>setnx(&quot;lock&quot;,UUID)</code> 尝试获取到锁，Redis 的实现保证了只会有一个 client 成功，假如 client A 运气好成功了</li><li>client A 紧接着马上设置一个过期时间<code>expire(&quot;lock&quot;,10)</code></li><li>client A 继续执行业务逻辑</li><li>执行完业务逻辑后释放锁</li></ol><p>如果程序能够正常走，好像也没什么问题...但我们知道分布式架构中，网络是不可靠的，如果在设置过期时间前 client B 挂掉咯，那就 GG 了，因为没有设置过期时间，那就成死锁了.. 就像下面这样</p><p><img data-src="https://pic3.zhimg.com/80/v2-ce8a50e076035057f20bbc7527fb9496_720w.jpg" alt="img"></p><p>所以我们需要保证<code>setnx</code>和<code>expire</code>的原子性。在 Redis 2.6.12 之后增强了<code>setnx</code>命令，可以同时设置过期时间，从而保证原子性。</p><p><img data-src="https://pic3.zhimg.com/80/v2-3b5f6b1211a6b1ef0384d82a3ed2d202_720w.jpg" alt="img"></p><p>解决了死锁问题，再来看看过期时间的问题，我们如何判断我们应该设置多长时间的过期时间？</p><ul><li>设置短了，业务逻辑可能还没执行完，锁被释放了，被其它线程获取执行</li><li>设置长了，需要业务逻辑处理完了自己释放锁（同样会存在线程挂掉的情况）</li></ul><p>其实我们想要到达一种效果，如果能够自动<strong>续期</strong>，锁快要过期了，但是业务操作还没有处理完，就自动对锁进行续期。Java 中的 Redisson 客户端就通过 watch dog 机制（守护线程）来支持这个功能。</p><p>通过 Redisson 客户端获取锁时会创建一个守护线程，通过守护线程来定期 check 过期时间，如果业务逻辑还在运行，那么就会续时。如果程序宕机，那么守护线程也会一起挂掉，redis 中的锁也将不会再次续时，最后过期。从而自动实现续期且不会出现死锁的问题。</p><p>简单回顾一下，我们解决了</p><ul><li>获取锁和设置过期时间的原子性问题</li><li>过期时间自动续时的问题</li></ul><p>在单机模式下看起来已经没什么问题了。而在生产环境下一般都会是集群模式，比如哨兵模式。得益于 Redis 的 AP 架构，选择了可用性，使得其性能非常好，但也正是因为AP架构，可能会导致数据丢失的情况。</p><p><img data-src="https://pic2.zhimg.com/80/v2-f688f0fffc79c1cb684cdefe63277ee5_720w.jpg" alt="img"></p><ol><li>client A 获取锁成功</li><li>master 节点在同步锁信息到 slave 节点时，master 宕机，信息没有向 slave 节点同步成功</li><li>slave 节点通过选举成为 master 节点</li><li>client B 再次获取相同的锁，发现 slave 节点上并没有其它线程占用，所以也获取到了锁</li><li>client A 和 client B 获取到了相同的锁</li></ol><p>当然，这个是非常极端的情况下会出现的问题；虽然 Redis 之父 Antirez 提出来了分布式锁的一种 「健壮」 的实现算法 RedLock，但依旧还是会有新的问题，比如节点奔溃重启、时钟跳跃...</p><p>总的来看，基于 Redis 实现分布式锁是很常用的，性能也比较高，满足绝大部分业务场景，如果我们能够接受非常极端情况下带来的锁丢失问题，Redis 分布式锁是个很好的选择。</p><h3 id="基于Zookeeper-：CP-架构"><a href="#基于Zookeeper-：CP-架构" class="headerlink" title="基于Zookeeper ：CP 架构"></a>基于Zookeeper ：CP 架构</h3><p>Zookeeper 是一种提供「分布式服务协调」的中心化服务，是以 Paxos 算法为基础实现的。Zookeeper 采用的是 CP 架构，选择了强一致性，这也就意味着不会像 Redis 那样出现数据丢失的情况（主从切换时），但为了实现强一致性，那么性能肯定是要比 Redis 差一些。</p><p>使用 Zookeeper 来实现分布式锁是比较简单的</p><ol><li>client 会在 Zookeeper 中创建一个<strong>临时节点</strong>，比如`/zk/lock</li><li>如果获取成功，那么 client 会创建一个 session 保持和 Zookeeper <strong>临时节点</strong>的关联</li><li>client 处理业务逻辑</li><li>client 处理完业务逻辑后删除 <strong>临时节点</strong>，关闭 session</li></ol><p>如果 client 宕机，那么 session 就会结束，临时节点也会自动删除，其它 client 就可以创建 <code>lock</code> 节点。</p><p>session 的维护是依赖于 client 的定时心跳来维护的，也就是说，如果 client 没有及时的给 Zookeeper 发送心跳检查，那么 Zookeeper 就会认为这个 session 已经过期了，就会删除调临时节点。比如出现长时间的 GC 或者长时间的网络延迟，都可能会导致临时节点被删除的可能。</p><p>对于 Zookeeper 来说，实现分布式锁从使用者角度来看比较简单，不需要考虑太多的东西，比如过期时间的设置。但维护成本会比较高，性能相对 Redis 也会差一些，以及可能会出现长时间失联导致的节点数据丢失的问题。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>优先使用基于数据库的乐观锁</li><li>如果期望更高的性能且能够接受极少数情况的锁丢失，那么优先选择 Redis</li><li>如果期望尽可能的避免锁丢失，优先选择 Zookeeper，且考虑 GC 时间和 心跳检查的设置</li><li>在分布式系统中极端情况下，分布式锁都不太可靠，所以需要我们在业务层面的入口也相应的隔离，在真的发生了锁丢失导致的数据不一致的情况做对应的补偿</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang=""><link itemprop="mainEntityOfPage" href="http://xiaojianzheng.cn/2022/09/24/MySQL-Explain/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="JIAHE"><meta itemprop="description" content="Collection & Reuse"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="JIAHE"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/09/24/MySQL-Explain/" class="post-title-link" itemprop="url">MySQL Explain</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-24 10:30:04" itemprop="dateCreated datePublished" datetime="2022-09-24T10:30:04+08:00">2022-09-24</time></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="Explain简介"><a href="#Explain简介" class="headerlink" title="Explain简介"></a>Explain简介</h2><p>本文主要讲述如何通过 explain 命令获取 select 语句的执行计划，通过 explain 我们可以知道以下信息：表的读取顺序，数据读取操作的类型，哪些索引可以使用，哪些索引实际使用了，表之间的引用，每张表有多少行被优化器查询等信息。</p><p>下面是使用 explain 的例子：</p><p>在 select 语句之前增加 explain 关键字，<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cdb?from=10680">MySQL</a> 会在查询上设置一个标记，执行查询时，会返回执行计划的信息，而不是执行这条SQL（如果 from 中包含子查询，仍会执行该子查询，将结果放入临时表中）。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br></pre></td></tr></table></figure><p>在查询中的每个表会输出一行，如果有两个表通过 join 连接查询，那么会输出两行。表的意义相当广泛：可以是子查询、一个 union 结果等。</p><p>explain 有两个变种：</p><p>1）<strong>explain extended</strong>：会在 explain 的基础上额外提供一些查询优化的信息。紧随其后通过 show warnings 命令可以 得到优化后的查询语句，从而看出优化器优化了什么。额外还有 filtered 列，是一个半分比的值，rows * filtered/100 可以估算出将要和 explain 中前一个表进行连接的行数（前一个表指 explain 中的id值比当前表id值小的表）。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain extended <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> const <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> warnings;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+--------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Level <span class="operator">|</span> Code <span class="operator">|</span> Message                                                                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+--------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Note  <span class="operator">|</span> <span class="number">1003</span> <span class="operator">|</span> <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">AS</span> `id`,<span class="string">&#x27;film1&#x27;</span> <span class="keyword">AS</span> `name` <span class="keyword">from</span> `test`.`film` <span class="keyword">where</span> <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+--------------------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>2）<strong>explain partitions</strong>：相比 explain 多了个 partitions 字段，如果查询是基于分区表的话，会显示查询将访问的分区。</p><h2 id="Explain中的列"><a href="#Explain中的列" class="headerlink" title="Explain中的列"></a>Explain中的列</h2><p>接下来我们将展示 explain 中每个列的信息。</p><h3 id="1-id列"><a href="#1-id列" class="headerlink" title="1. id列"></a>1. id列</h3><p>id列的编号是 select 的序列号，有几个 select 就有几个id，并且id的顺序是按 select 出现的顺序增长的。MySQL将 select 查询分为简单查询和复杂查询。复杂查询分为三类：简单子查询、派生表（from语句中的子查询）、union 查询。</p><p>1）简单子查询</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> actor limit <span class="number">1</span>) <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">32</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> SUBQUERY    <span class="operator">|</span> actor <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">PRIMARY</span>  <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+ </span></span><br></pre></td></tr></table></figure><p>2）from子句中的子查询</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> id <span class="keyword">from</span> (<span class="keyword">select</span> id <span class="keyword">from</span> film) <span class="keyword">as</span> der;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="operator">&lt;</span>derived2<span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">ALL</span>   <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> DERIVED     <span class="operator">|</span> film       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">32</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>这个查询执行时有个临时表别名为der，外部 select 查询引用了这个临时表</p><p>3）union查询</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type  <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>      <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> <span class="keyword">UNION</span>        <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">UNION</span> <span class="keyword">RESULT</span> <span class="operator">|</span> <span class="operator">&lt;</span>union1,<span class="number">2</span><span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br></pre></td></tr></table></figure><p>union结果总是放在一个匿名临时表中，临时表不在SQL总出现，因此它的id是NULL。</p><h3 id="2-select-type列"><a href="#2-select-type列" class="headerlink" title="2. select_type列"></a>2. select_type列</h3><p>select_type 表示对应行是是简单还是复杂的查询，如果是复杂的查询，又是上述三种复杂查询中的哪一种。</p><p>1）<strong>simple</strong>：简单查询。查询不包含子查询和union</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> const <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span></span><br></pre></td></tr></table></figure><p>2）<strong>primary</strong>：复杂查询中最外层的 select</p><p>3）<strong>subquery</strong>：包含在 select 中的子查询（不在 from 子句中）</p><p>4）<strong>derived</strong>：包含在 from 子句中的子查询。MySQL会将结果存放在一个临时表中，也称为派生表（derived的英文含义）</p><p>用这个例子来了解 primary、subquery 和 derived 类型</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> actor <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>) der;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type   <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="operator">&lt;</span>derived3<span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">system</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> DERIVED     <span class="operator">|</span> film       <span class="operator">|</span> const  <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> SUBQUERY    <span class="operator">|</span> actor      <span class="operator">|</span> const  <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+-------------+ </span></span><br></pre></td></tr></table></figure><p>5）<strong>union</strong>：在 union 中的第二个和随后的 select</p><p>6）<strong>union result</strong>：从 union 临时表检索结果的 select</p><p>用这个例子来了解 union 和 union result 类型：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type  <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>      <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> <span class="keyword">UNION</span>        <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">UNION</span> <span class="keyword">RESULT</span> <span class="operator">|</span> <span class="operator">&lt;</span>union1,<span class="number">2</span><span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br></pre></td></tr></table></figure><h3 id="3-table列"><a href="#3-table列" class="headerlink" title="3. table列"></a>3. table列</h3><p>这一列表示 explain 的一行正在访问哪个表。</p><p>当 from 子句中有子查询时，table列是<derivenn> 格式，表示当前查询依赖 id=N 的查询，于是先执行 id=N 的查询。当有 union 时，UNION RESULT 的 table 列的值为 &lt;union1,2&gt;，1和2表示参与 union 的 select 行id。</derivenn></p><h3 id="4-type列"><a href="#4-type列" class="headerlink" title="4. type列"></a>4. type列</h3><p>这一列表示关联类型或访问类型，即MySQL决定如何查找表中的行。</p><p>依次从最优到最差分别为：system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</p><p>**<code>NULL</code>**：mysql能够在优化阶段分解查询语句，在执行阶段用不着再访问表或索引。例如：在索引列中选取最小值，可以单独查找索引来完成，不需要在执行时访问表</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="built_in">min</span>(id) <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">Select</span> tables optimized away <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+------------------------------+</span></span><br></pre></td></tr></table></figure><p>**<code>const, system</code>**：mysql能对查询的某部分进行优化并将其转化成一个常量（可以看show warnings 的结果）。用于 primary key 或 unique key 的所有列与常数比较时，所以表最多有一个匹配行，读取1次，速度比较快。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain extended <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>) tmp;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type   <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="operator">&lt;</span>derived2<span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">system</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> DERIVED     <span class="operator">|</span> film       <span class="operator">|</span> const  <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> warnings;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+---------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Level <span class="operator">|</span> Code <span class="operator">|</span> Message                                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+---------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Note  <span class="operator">|</span> <span class="number">1003</span> <span class="operator">|</span> <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">AS</span> `id`,<span class="string">&#x27;film1&#x27;</span> <span class="keyword">AS</span> `name` <span class="keyword">from</span> dual <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+---------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>**<code>eq_ref</code>**：primary key 或 unique key 索引的所有部分被连接使用 ，最多只会返回一条符合条件的记录。这可能是在 const 之外最好的联接类型了，简单的 select 查询不会出现这种 type。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film_actor <span class="keyword">left</span> <span class="keyword">join</span> film <span class="keyword">on</span> film_actor.film_id <span class="operator">=</span> film.id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+-------------------+---------+-------------------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type   <span class="operator">|</span> possible_keys <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>                     <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+-------------------+---------+-------------------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> index  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">8</span>       <span class="operator">|</span> <span class="keyword">NULL</span>                    <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film       <span class="operator">|</span> eq_ref <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span>           <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.film_actor.film_id <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+-------------------+---------+-------------------------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>**<code>ref</code>**：相比 <code>eq_ref</code>，不使用唯一索引，而是使用普通索引或者唯一性索引的部分前缀，索引要和某个值相比较，可能会找到多个符合条件的行。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 简单 <span class="keyword">select</span> 查询，name是普通索引（非唯一索引）</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> name <span class="operator">=</span> &quot;film1&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> idx_name      <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>关联表查询，idx_film_actor_id是film_id和actor_id的联合索引，这里使用到了film_actor的左边前缀film_id部分。</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">left</span> <span class="keyword">join</span> film_actor <span class="keyword">on</span> film.id <span class="operator">=</span> film_actor.film_id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type  <span class="operator">|</span> possible_keys     <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>          <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span> idx_name          <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.film.id <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>**<code>ref_or_null</code>**：类似<code>ref</code>，但是可以搜索值为NULL的行。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> name <span class="operator">=</span> &quot;film1&quot; <span class="keyword">or</span> name <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type        <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> ref_or_null <span class="operator">|</span> idx_name      <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+---------------+----------+---------+-------+------+--------------------------+</span></span><br></pre></td></tr></table></figure><p>**<code>index_merge</code>**：表示使用了索引合并的优化方法。 例如下表：id是主键，tenant_id是普通索引。or 的时候没有用 primary key，而是使用了 primary key(id) 和 tenant_id 索引</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> role <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">11011</span> <span class="keyword">or</span> tenant_id <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+-----------------------+-----------------------+---------+------+------+-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type        <span class="operator">|</span> possible_keys         <span class="operator">|</span> key                   <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+-----------------------+-----------------------+---------+------+------+-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> role  <span class="operator">|</span> index_merge <span class="operator">|</span> <span class="keyword">PRIMARY</span>,idx_tenant_id <span class="operator">|</span> <span class="keyword">PRIMARY</span>,idx_tenant_id <span class="operator">|</span> <span class="number">4</span>,<span class="number">4</span>     <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>  <span class="number">134</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">union</span>(<span class="keyword">PRIMARY</span>,idx_tenant_id); <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+-----------------------+-----------------------+---------+------+------+-------------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>**<code>range</code>**：范围扫描通常出现在 in(), between ,&gt; ,&lt;, &gt;= 等操作中。使用一个索引来检索给定范围的行。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">range</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>**<code>index</code>**：和ALL一样，不同就是mysql只需扫描索引树，这通常比ALL快一些。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>**<code>ALL</code>**：即全表扫描，意味着mysql需要从头到尾去查找所需要的行。通常情况下这需要增加索引来进行优化了</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br></pre></td></tr></table></figure><h3 id="5-possible-keys列"><a href="#5-possible-keys列" class="headerlink" title="5. possible_keys列"></a>5. possible_keys列</h3><p>这一列显示查询可能使用哪些索引来查找。</p><p>explain 时可能出现 possible_keys 有列，而 key 显示 NULL 的情况，这种情况是因为表中数据不多，mysql认为索引对此查询帮助不大，选择了全表查询。</p><p>如果该列是NULL，则没有相关的索引。在这种情况下，可以通过检查 where 子句看是否可以创造一个适当的索引来提高查询性能，然后用 explain 查看效果。</p><h3 id="6-key列"><a href="#6-key列" class="headerlink" title="6. key列"></a>6. key列</h3><p>这一列显示mysql实际采用哪个索引来优化对该表的访问。</p><p>如果没有使用索引，则该列是 NULL。如果想强制mysql使用或忽视possible_keys列中的索引，在查询中使用 force index、ignore index。</p><h3 id="7-key-len列"><a href="#7-key-len列" class="headerlink" title="7. key_len列"></a>7. key_len列</h3><p>这一列显示了mysql在索引里使用的字节数，通过这个值可以算出具体使用了索引中的哪些列。</p><p>举例来说，film_actor的联合索引 idx_film_actor_id 由 film_id 和 actor_id 两个int列组成，并且每个int是4字节。通过结果中的key_len=4可推断出查询使用了第一个列：film_id列来执行索引查找。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film_actor <span class="keyword">where</span> film_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type <span class="operator">|</span> possible_keys     <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>key_len计算规则如下：</p><ul><li>字符串<ul><li>char(n)：n字节长度</li><li>varchar(n)：2字节存储字符串长度，如果是utf-8，则长度 3n + 2</li></ul></li><li>数值类型<ul><li>tinyint：1字节</li><li>smallint：2字节</li><li>int：4字节</li><li>bigint：8字节　　</li></ul></li><li>时间类型　<ul><li>date：3字节</li><li>timestamp：4字节</li><li>datetime：8字节</li></ul></li><li>如果字段允许为 NULL，需要1字节记录是否为 NULL</li></ul><p>索引最大长度是768字节，当字符串过长时，mysql会做一个类似左前缀索引的处理，将前半部分的字符提取出来做索引。</p><h3 id="8-ref列"><a href="#8-ref列" class="headerlink" title="8. ref列"></a>8. ref列</h3><p>这一列显示了在key列记录的索引中，表查找值所用到的列或常量，常见的有：const（常量），func，NULL，字段名（例：film.id）</p><h3 id="9-rows列"><a href="#9-rows列" class="headerlink" title="9. rows列"></a>9. rows列</h3><p>这一列是mysql估计要读取并检测的行数，注意这个不是结果集里的行数。</p><h3 id="10-Extra列"><a href="#10-Extra列" class="headerlink" title="10. Extra列"></a>10. Extra列</h3><p>这一列展示的是额外信息。常见的重要值如下：</p><p><strong><code>distinct</code></strong>: 一旦mysql找到了与行相联合匹配的行，就不再搜索了</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> film <span class="keyword">left</span> <span class="keyword">join</span> film_actor <span class="keyword">on</span> film.id <span class="operator">=</span> film_actor.film_id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type  <span class="operator">|</span> possible_keys     <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>          <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film       <span class="operator">|</span> index <span class="operator">|</span> idx_name          <span class="operator">|</span> idx_name          <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.film.id <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Distinct</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+------------------------------+</span></span><br></pre></td></tr></table></figure><p>**<code>Using index</code>**：这发生在对表的请求列都是同一索引的部分的时候，返回的列数据只使用了索引中的信息，而没有再去访问表中的行记录。是性能高的表现。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> id <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+ </span></span><br></pre></td></tr></table></figure><p>**<code>Using where</code>**：mysql服务器将在存储引擎检索行后再进行过滤。就是先读取整行数据，再按 where 条件进行检查，符合就留下，不符合就丢弃。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+--------------------------+</span></span><br></pre></td></tr></table></figure><p>**<code>Using temporary</code>**：mysql需要创建一张临时表来处理查询。出现这种情况一般是要进行优化的，首先是想到用索引来优化。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> actor.name没有索引，此时创建了张临时表来<span class="keyword">distinct</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> actor;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> film.name建立了idx_name索引，此时查询时extra是<span class="keyword">using</span> index,没有用临时表</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> idx_name      <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>**<code>Using filesort</code>**：mysql 会对结果使用一个外部索引排序，而不是按索引次序从表里读取行。此时mysql会根据联接类型浏览所有符合条件的记录，并保存排序关键字和行指针，然后排序关键字并按顺序检索行信息。这种情况下一般也是要考虑使用索引来优化的。</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> actor.name未创建索引，会浏览actor整个表，保存排序关键字name和对应的id，然后排序name并检索行记录</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> film.name建立了idx_name索引,此时查询时extra是<span class="keyword">using</span> index</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure><h2 id="使用的表"><a href="#使用的表" class="headerlink" title="使用的表"></a>使用的表</h2><p>以上所有sql使用的表和数据：</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `actor`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `actor` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `actor` (`id`, `name`, `update_time`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;2017-12-22 15:27:18&#x27;</span>), (<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;2017-12-22 15:27:18&#x27;</span>), (<span class="number">3</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;2017-12-22 15:27:18&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `film`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `film` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`),</span><br><span class="line">  KEY `idx_name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `film` (`id`, `name`) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;film0&#x27;</span>),(<span class="number">1</span>,<span class="string">&#x27;film1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;film2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `film_actor`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `film_actor` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `film_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `actor_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`),</span><br><span class="line">  KEY `idx_film_actor_id` (`film_id`,`actor_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `film_actor` (`id`, `film_id`, `actor_id`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>《高性能MySQL》: 附录D</li><li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">mysql官方文档-explain</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang=""><link itemprop="mainEntityOfPage" href="http://xiaojianzheng.cn/2022/09/22/SSH-Java/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="JIAHE"><meta itemprop="description" content="Collection & Reuse"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="JIAHE"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/09/22/SSH-Java/" class="post-title-link" itemprop="url">SSH-Java</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-22 17:10:25" itemprop="dateCreated datePublished" datetime="2022-09-22T17:10:25+08:00">2022-09-22</time></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="AbstractAppCommand"><a href="#AbstractAppCommand" class="headerlink" title="AbstractAppCommand"></a>AbstractAppCommand</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.IoUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.net.NetUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ReUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RuntimeUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ftp.AbstractFtp;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.ChannelType;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.JschUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.Sftp;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.system.SystemUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.framework.askja.common.CommonUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.framework.askja.exception.BizException;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.AppConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.service.dto.PortDTO;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.*;</span><br><span class="line"><span class="keyword">import</span> com.profesorfalken.jpowershell.PowerShell;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAppCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String osType = SystemUtil.getOsInfo().isLinux() ? <span class="string">&quot;Linux&quot;</span> : <span class="string">&quot;Windows&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String localhost;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Charset charset = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> SshConfigDTO sshConfigDTO;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Sftp sftp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String powerShellExecutablePath = <span class="string">&quot;pwsh&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            localhost = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;获取IP地址异常, &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (osType.equals(<span class="string">&quot;Windows&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String path = Optional.ofNullable(RuntimeUtil.execForStr(<span class="string">&quot;which pwsh&quot;</span>)).orElse(<span class="string">&quot;&quot;</span>).trim();</span><br><span class="line">                <span class="keyword">if</span> (StrUtil.isNotBlank(path) &amp;&amp; FileUtil.exist(path)) &#123;</span><br><span class="line">                    powerShellExecutablePath = path;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SshConfigDTO <span class="title">getSshConfigDTO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sshConfigDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Function&lt;SshConfigDTO, String&gt; getCacheKey =</span><br><span class="line">            dto -&gt; StrUtil.format(<span class="string">&quot;&#123;&#125;@&#123;&#125;:&#123;&#125;:&#123;&#125;&quot;</span>, dto.getUsername(), dto.getHost(), dto.getPort(), dto.getConnectType());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractAppCommand</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sshConfigDTO = sshConfigDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractAppCommand <span class="title">getInstance</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sshConfigDTO.isLinux()) &#123;</span><br><span class="line">            <span class="keyword">return</span> LinuxAppCommand.getInstance(sshConfigDTO);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sshConfigDTO.isWindows()) &#123;</span><br><span class="line">            <span class="keyword">return</span> WindowsAppCommand.getInstance(sshConfigDTO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;不支持的：&#123;&#125;&quot;</span>, sshConfigDTO.getOsType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPidNumber</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(text)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(ReUtil.getGroup1(<span class="string">&quot;.*?(\\d+).*?&quot;</span>, text));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sftp <span class="title">getSftp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSftp(AbstractFtp.DEFAULT_CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sftp <span class="title">getSftp</span><span class="params">(Charset charset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sftp == <span class="keyword">null</span> || sftp.getClient().isClosed()) &#123;</span><br><span class="line">            sftp = <span class="keyword">new</span> Sftp(getChannelSftp(), charset);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!sftp.getClient().isConnected()) &#123;</span><br><span class="line">            sftp.reconnectIfTimeout();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sftp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeSftp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JschUtil.close(sftp.getClient());</span><br><span class="line">        sftp = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ChannelSftp <span class="title">getChannelSftp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JschUtil.openSftp(sshConfigDTO.getJschSession(), <span class="number">60000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            JschSessionPool.INSTANCE.close(sshConfigDTO);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InetSocketAddress address = NetUtil.createAddress(sshConfigDTO.getHost(), sshConfigDTO.getPort());</span><br><span class="line">        <span class="keyword">if</span> (!NetUtil.isOpen(address, <span class="number">3000</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;IP：&#123;&#125; Port: &#123;&#125; 无法连接&quot;</span>, sshConfigDTO.getHost(), sshConfigDTO.getPort() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (appExistLocalMachine()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sshConfigDTO.getJschSession().isConnected();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">buildExecuteCommands</span><span class="params">(String command)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================ 进程相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStartProcessCommand</span><span class="params">(AppConfigDTO appConfigDTO, SshConfigDTO sshConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildKillCommand</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildGetPortCommand</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildGetProcessMemoryCommand</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getServerFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getPidFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildGetPidCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStopServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildRestartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildTailFileCommand</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildStopTailFileCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================ 进程相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================ 系统相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将路径列表中的所有文件打包为zip压缩包</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePathList 待压缩的路径集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> zip压缩包的路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">compressToZip</span><span class="params">(List&lt;String&gt; filePathList)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文件或文件夹的总计大小，单位 kb</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件或文件夹的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 总计大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文件的MD5值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> MD5值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getFileMd5</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppJarMd5</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appJarPath = appConfigDTO.getAppJarPath();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = getFile(appJarPath);</span><br><span class="line">        File tempFile = FileUtil.createTempFile(appConfigDTO.getAppName(), <span class="string">&quot;.jar&quot;</span>, <span class="keyword">new</span> File(<span class="string">&quot;.&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        FileUtil.writeBytes(bytes, tempFile);</span><br><span class="line">        <span class="keyword">try</span> (JarFile jarFile = <span class="keyword">new</span> JarFile(tempFile)) &#123;</span><br><span class="line">            JarEntry md5Entry = jarFile.getJarEntry(<span class="string">&quot;BOOT-INF/classes/MD5&quot;</span>);</span><br><span class="line">            String md5 = IoUtil.read(jarFile.getInputStream(md5Entry), StandardCharsets.UTF_8);</span><br><span class="line">            log.info(<span class="string">&quot;获取文件&#123;&#125;的MD5：&#123;&#125;&quot;</span>, appJarPath, md5);</span><br><span class="line">            <span class="keyword">return</span> md5;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            FileUtil.del(tempFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getMemoryUsedRateCommand</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMemoryUsedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = getMemoryUsedRateCommand();</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getCpuUsedRateCommand</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCpuUsedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = getCpuUsedRateCommand();</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getDiskUsedRateCommand</span><span class="params">(List&lt;String&gt; mountedDir)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDiskUsedRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = getDiskUsedRateCommand(sshConfigDTO.getMountedDirList());</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================== 系统相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================== 文件相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getFileContent</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">writeFileContent</span><span class="params">(String content, String filePath, SshConfigDTO sshConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String sourcePath, String targetPath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(String sourcePath, String targetPath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">mkdir</span><span class="params">(String newDirPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSftp().mkdir(newDirPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">fileExist</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">deleteFile</span><span class="params">(String filePath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(String dirPath)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 变更文件或目录的权限</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * /bin/chmod $&#123;params&#125; $&#123;filePath&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params   chmod命令后面的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">chmod</span><span class="params">(String filePath, String params)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChannelSftp.LsEntry&gt; listDir(String dirPath) &#123;</span><br><span class="line">        <span class="keyword">return</span> getSftp().lsEntries(dirPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索包含关键字的文件，类似find命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dirPath   基于搜索的目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyword   关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> recursive 是否递归搜索</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 匹配的所有文件绝对路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">listDir</span><span class="params">(String dirPath, String keyword, <span class="keyword">boolean</span> recursive)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkShellFileCanExecute</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        Sftp sftp = getSftp();</span><br><span class="line">        List&lt;ChannelSftp.LsEntry&gt; lsEntries = sftp.lsEntries(filePath);</span><br><span class="line">        <span class="keyword">if</span> (lsEntries.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ChannelSftp.LsEntry file = lsEntries.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> file.getAttrs().getPermissions() &gt; <span class="number">0</span>;</span><br><span class="line"><span class="comment">//        String command = String.format(&quot;ls -l %s | awk &#x27;&#123;print $1&#125;&#x27;&quot;, filePath);</span></span><br><span class="line"><span class="comment">//        // -rwxr-xr-x.</span></span><br><span class="line"><span class="comment">//        String result;</span></span><br><span class="line"><span class="comment">//        if (session == null) &#123;</span></span><br><span class="line"><span class="comment">//            result = exec(command, CharsetUtil.UTF_8);</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;</span></span><br><span class="line"><span class="comment">//            result = JschUtil.exec(session, command, CharsetUtil.UTF_8);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return result.charAt(3) == &#x27;x&#x27; &amp;&amp; result.charAt(6) == &#x27;x&#x27;;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopTailLog</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String command = buildStopTailFileCommand(appConfigDTO);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getTailLogInputStream</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String allLogPath = appConfigDTO.getAppAllLogPath();</span><br><span class="line">        String buildTailFileCommand = buildTailFileCommand(allLogPath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> exec(buildTailFileCommand);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;获取日志文件流失败&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;获取日志文件流失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFileBySsh</span><span class="params">(String sourcePath, String destPath, SftpProgressMonitor monitor, Sftp.Mode mode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// sftp上传只支持 /C:/qingting/lib 这样的路径</span></span><br><span class="line">        String source = (isWindowsPath(sourcePath) ? <span class="string">&quot;/&quot;</span> : <span class="string">&quot;&quot;</span>) + sourcePath;</span><br><span class="line">        String target = (isWindowsPath(destPath) ? <span class="string">&quot;/&quot;</span> : <span class="string">&quot;&quot;</span>) + destPath;</span><br><span class="line">        Sftp currentSftp = getSftp();</span><br><span class="line">        currentSftp.put(source, target, monitor, mode);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(String destPath, String fileName, InputStream fileStream, SftpProgressMonitor monitor, Sftp.Mode mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appExistLocalMachine()) &#123;</span><br><span class="line">            FileUtil.mkdir(destPath);</span><br><span class="line">            FileUtil.writeFromStream(fileStream, destPath + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// sftp上传只支持 /C:/qingting/lib 这样的路径</span></span><br><span class="line">            String dirPath = destPath;</span><br><span class="line">            <span class="keyword">if</span> (isWindowsPath(destPath)) &#123;</span><br><span class="line">                dirPath = <span class="string">&quot;/&quot;</span> + destPath;</span><br><span class="line">            &#125;</span><br><span class="line">            Sftp currentSftp = getSftp();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> currentSftp.upload(dirPath, fileName, fileStream);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    destPath = StrUtil.addSuffixIfNot(destPath, StrUtil.SLASH) + StrUtil.removePrefix(fileName, StrUtil.SLASH);</span><br><span class="line">                    currentSftp.put(fileStream, destPath, monitor, mode);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;上传文件失败, &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                closeSftp();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(String destPath, String fileName, InputStream fileStream, SftpProgressMonitor monitor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uploadFile(destPath, fileName, fileStream, monitor, Sftp.Mode.OVERWRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(String destPath, String fileName, InputStream fileStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uploadFile(destPath, fileName, fileStream, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(File uploadFile, String directory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uploadFile(directory, uploadFile.getName(), FileUtil.getInputStream(uploadFile));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(List&lt;File&gt; uploadFile, String directory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ChannelSftp channelSftp = getChannelSftp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channelSftp.mkdir(directory);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.debug(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channelSftp.cd(directory);</span><br><span class="line">            uploadFile.forEach(file -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> (InputStream in = FileUtil.getInputStream(file)) &#123;</span><br><span class="line">                    channelSftp.put(in, file.getName());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SftpException e) &#123;</span><br><span class="line">                    <span class="comment">// 指定上传路径不存在</span></span><br><span class="line">                    <span class="keyword">if</span> (ChannelSftp.SSH_FX_NO_SUCH_FILE == e.id) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;上传路径不存在&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.error(e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;上传Jar失败&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;上传&#123;&#125;至&#123;&#125;失败&quot;</span>, file.getAbsolutePath(), sshConfigDTO.getHost());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;上传Jar失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SftpException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;上传Jar失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JschUtil.close(channelSftp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getFile(String filePath) &#123;</span><br><span class="line">        Sftp sftp = getSftp();</span><br><span class="line">        <span class="keyword">try</span> (ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream()) &#123;</span><br><span class="line">            sftp.download(handleWindowsPathForSftp(filePath), outputStream);</span><br><span class="line">            <span class="keyword">return</span> outputStream.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;读取&#123;&#125;文件流失败&quot;</span>, filePath, e);</span><br><span class="line">            JschUtil.close(sftp.getClient());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;读取&#123;&#125;文件流失败&quot;</span>, filePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================================================================================== 文件相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================== 进程、服务相关 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String startServiceCommand = buildStartServiceCommand(appConfigDTO);</span><br><span class="line">        log.info(<span class="string">&quot;start command =&gt; &#123;&#125;&quot;</span>, startServiceCommand);</span><br><span class="line">        String result = execSystemCommand(startServiceCommand);</span><br><span class="line">        log.info(<span class="string">&quot;result =&gt; &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (pid &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;启动&#123;&#125;失败&quot;</span>, appConfigDTO.getAppName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String stopServiceCommand = buildStopServiceCommand(appConfigDTO);</span><br><span class="line">        log.info(<span class="string">&quot;stop command =&gt; &#123;&#125;&quot;</span>, stopServiceCommand);</span><br><span class="line">        String result = execSystemCommand(stopServiceCommand, <span class="keyword">null</span>);</span><br><span class="line">        log.info(<span class="string">&quot;result =&gt; &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String killCommand = buildKillCommand(pid);</span><br><span class="line">            execSystemCommand(killCommand);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;停止&#123;&#125;失败&quot;</span>, appConfigDTO.getAppName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restart</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String restartServiceCommand = buildRestartServiceCommand(appConfigDTO);</span><br><span class="line">        log.info(<span class="string">&quot;restart command =&gt; &#123;&#125;&quot;</span>, restartServiceCommand);</span><br><span class="line">        String result = execSystemCommand(restartServiceCommand, <span class="keyword">null</span>);</span><br><span class="line">        log.info(<span class="string">&quot;result =&gt; &#123;&#125;&quot;</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">(AppConfigDTO appConfigDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getPort</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pid = getPid(appConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> getPort(pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getPort</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line"></span><br><span class="line">        String getPortCommand = buildGetPortCommand(pid);</span><br><span class="line">        String result = execSystemCommand(getPortCommand);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(result)) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(result.split(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">                .peek(log::debug)</span><br><span class="line">                .map(text -&gt; ReUtil.getGroup1(<span class="string">&quot;.*?:(\\d+).*?&quot;</span>, text))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsedMemory</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String getMemoryCommand = buildGetProcessMemoryCommand(pid);</span><br><span class="line">            String result = execSystemCommand(getMemoryCommand);</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(result)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ReUtil.getGroup1(<span class="string">&quot;.*?([\\d,]+) ?K?$&quot;</span>, result).replace(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> StrUtil.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================ 进程、服务相关 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 start</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否启用防火墙</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">enableFirewall</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前开放端口列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;PortDTO&gt; <span class="title">listPorts</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">listRichRules</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开放端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">openPort</span><span class="params">(<span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开放端口给指定IP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">openPortToIp</span><span class="params">(String ip, <span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制IP访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">limitIp</span><span class="params">(String ip)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制端口访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">limitPort</span><span class="params">(<span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制指定IP访问端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">limitIpPort</span><span class="params">(String ip, <span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================ 基础方法 start</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execSystemCommand</span><span class="params">(List&lt;String&gt; commands)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exec(commands, charset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execSystemCommand</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command, charset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在指定文件夹下执行命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command 命令</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">execSystemCommand</span><span class="params">(String command, Charset charset)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; commands = buildExecuteCommands(command);</span><br><span class="line">        <span class="keyword">if</span> (appExistLocalMachine()) &#123;</span><br><span class="line">            <span class="keyword">return</span> exec(commands, charset);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> jschExec(String.join(<span class="string">&quot;\n;&quot;</span>, commands), charset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地执行命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmds 命令行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">exec</span><span class="params">(List&lt;String&gt; cmds, Charset charset)</span> </span>&#123;</span><br><span class="line">        String result;</span><br><span class="line">        log.debug(<span class="string">&quot;准备执行的命令：&#123;&#125;&quot;</span>, cmds);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sshConfigDTO.isWindows()) &#123;</span><br><span class="line">                <span class="keyword">try</span> (PowerShell powerShell = PowerShell.openSession(powerShellExecutablePath)) &#123;</span><br><span class="line">                    result = powerShell.executeCommand(String.join(<span class="string">&quot;\n&quot;</span>, cmds)).getCommandOutput();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Process process = <span class="keyword">new</span> ProcessBuilder(cmds).directory(<span class="keyword">null</span>).redirectErrorStream(<span class="keyword">true</span>).start();</span><br><span class="line">                result = RuntimeUtil.getResult(process, charset == <span class="keyword">null</span> ? CharsetUtil.UTF_8 : charset);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;执行结果：&#123;&#125;&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> cleanResult(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;exec 执行命令失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 远程执行命令</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd 命令行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">jschExec</span><span class="params">(String cmd, Charset charset)</span> </span>&#123;</span><br><span class="line">        Session jschSession = sshConfigDTO.getJschSession();</span><br><span class="line">        log.debug(<span class="string">&quot;准备执行的命令：&#123;&#125;&quot;</span>, cmd);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = JschUtil.exec(jschSession, cmd, charset == <span class="keyword">null</span> ? CharsetUtil.UTF_8 : charset);</span><br><span class="line">            log.debug(<span class="string">&quot;执行结果：&#123;&#125;&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> cleanResult(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">            sshConfigDTO.closeJschSession();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;jsch 执行命令失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InputStream <span class="title">exec</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Session jschSession = sshConfigDTO.getJschSession();</span><br><span class="line">        ChannelExec channel = (ChannelExec) JschUtil.createChannel(jschSession, ChannelType.EXEC);</span><br><span class="line">        channel.setCommand(cmd);</span><br><span class="line">        channel.setInputStream(<span class="keyword">null</span>);</span><br><span class="line">        channel.setErrStream(System.err);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream inputStream = channel.getInputStream();</span><br><span class="line">            channel.connect(<span class="number">6000</span>);</span><br><span class="line">            <span class="keyword">return</span> inputStream;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;获取结果流失败，&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;获取结果流失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">cleanResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> result.replaceAll(<span class="string">&quot;Active code page: 65001(\r\n)?&quot;</span>, <span class="string">&quot;&quot;</span>).trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用是否部署在当前设备上</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">appExistLocalMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sshConfigDTO.getHost().equals(localhost) &amp;&amp; osType.equals(sshConfigDTO.getOsType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isWindowsPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path.matches(<span class="string">&quot;^[A-Z]:[\\\\/].*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">handleWindowsPathForSftp</span><span class="params">(String windowsPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isWindowsPath(windowsPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/&quot;</span> + windowsPath.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> windowsPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================================================ 基础方法 end</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="JschSessionPool"><a href="#JschSessionPool" class="headerlink" title="JschSessionPool"></a>JschSessionPool</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.Assert;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.SimpleCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.SecureUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.JschRuntimeException;</span><br><span class="line"><span class="keyword">import</span> com.haigui.common.util.encrypt.EncryptUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.JSch;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.JSchException;</span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.Session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">JschSessionPool</span> </span>&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SSH会话池，key：host，value：Session对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleCache&lt;String, Session&gt; cache = <span class="keyword">new</span> SimpleCache&lt;&gt;(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Predicate&lt;Session&gt; checkConnect = session -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (session.isConnected()) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.connect(<span class="number">6000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSchException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Session，不存在返回null</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Session <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cache.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得一个SSH跳板机会话，重用已经使用的会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshHost 跳板机主机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshPort 跳板机端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshUser 跳板机用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshPass 跳板机密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SSH会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Session <span class="title">getSession</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String sshPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String key = getCacheKey(sshHost, sshPort, sshUser, sshPass, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cache.get(key, checkConnect,</span><br><span class="line">                () -&gt; openSession(sshHost, sshPort, sshUser, <span class="keyword">null</span>, sshPass, <span class="number">60000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得一个SSH跳板机会话，重用已经使用的会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshHost    跳板机主机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshPort    跳板机端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sshUser    跳板机用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKey 跳板机私钥路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SSH会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Session <span class="title">getSession</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String privateKey, String sshPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String key = getCacheKey(sshHost, sshPort, sshUser, <span class="string">&quot;&quot;</span>, privateKey);</span><br><span class="line">        File tempFile = FileUtil.createTempFile(<span class="keyword">new</span> File(<span class="string">&quot;./temp&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtil.writeUtf8String(privateKey, tempFile);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.cache.get(key, checkConnect,</span><br><span class="line">                    () -&gt; openSession(sshHost, sshPort, sshUser, tempFile.getAbsolutePath(), sshPass, <span class="number">60000</span>));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            FileUtil.del(tempFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(SshConfigDTO dto)</span> </span>&#123;</span><br><span class="line">        String key = getCacheKey(dto.getHost(), dto.getPort(), dto.getUsername(), dto.getPassword(), dto.getPrivateKey());</span><br><span class="line">        close(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭SSH连接会话</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 主机，格式为user@host:port</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Session session = get(key);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span> &amp;&amp; session.isConnected()) &#123;</span><br><span class="line">            session.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.cache.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭所有SSH连接会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, Session&gt; entry : <span class="keyword">this</span>.cache) &#123;</span><br><span class="line">            session = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (session != <span class="keyword">null</span> &amp;&amp; session.isConnected()) &#123;</span><br><span class="line">                session.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cache.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getCacheKey</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String sshPass, String privateKeyPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SecureUtil.md5(StrUtil.format(<span class="string">&quot;&#123;&#125;@&#123;&#125;:&#123;&#125;&quot;</span>, sshUser, sshHost, sshPort, sshPass, privateKeyPath));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">openSession</span><span class="params">(String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String privateKeyPath, String sshPass, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JSch jsch = <span class="keyword">new</span> JSch();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(privateKeyPath) &amp;&amp; StrUtil.isBlank(sshPass)) &#123;</span><br><span class="line">                jsch.addIdentity(privateKeyPath);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StrUtil.isNotBlank(privateKeyPath) &amp;&amp; StrUtil.isBlank(sshPass)) &#123;</span><br><span class="line">                jsch.addIdentity(privateKeyPath, sshPass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSchException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JschRuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createSession(jsch, sshHost, sshPort, sshUser, sshPass, timeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSchException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JschRuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">createSession</span><span class="params">(JSch jsch, String sshHost, <span class="keyword">int</span> sshPort, String sshUser, String sshPass, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> JSchException </span>&#123;</span><br><span class="line">        Assert.notEmpty(sshHost, <span class="string">&quot;SSH Host must be not empty!&quot;</span>);</span><br><span class="line">        Assert.isTrue(sshPort &gt; <span class="number">0</span>, <span class="string">&quot;SSH port must be &gt; 0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认root用户</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(sshUser)) &#123;</span><br><span class="line">            sshUser = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == jsch) &#123;</span><br><span class="line">            jsch = <span class="keyword">new</span> JSch();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Session session = jsch.getSession(sshUser, sshHost, sshPort);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotEmpty(sshPass)) &#123;</span><br><span class="line">            session.setPassword(sshPass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置第一次登录的时候提示，可选值：(ask | yes | no)</span></span><br><span class="line">        session.setConfig(<span class="string">&quot;StrictHostKeyChecking&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br><span class="line">        session.setServerAliveCountMax(<span class="number">5</span>);</span><br><span class="line">        session.setServerAliveInterval(<span class="number">2000</span>);</span><br><span class="line">        session.connect(timeout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="LinuxAppCommand"><a href="#LinuxAppCommand" class="headerlink" title="LinuxAppCommand"></a>LinuxAppCommand</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.SimpleCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.text.CharSequenceUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.CharsetUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ReUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.framework.askja.exception.BizException;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.AppConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.service.dto.PortDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinuxAppCommand</span> <span class="keyword">extends</span> <span class="title">AbstractAppCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">&quot;sh&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = CharsetUtil.CHARSET_UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleCache&lt;String, LinuxAppCommand&gt; cache = <span class="keyword">new</span> SimpleCache&lt;&gt;(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinuxAppCommand <span class="title">getInstance</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        String cacheKey = getCacheKey.apply(sshConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> cache.get(cacheKey, () -&gt; <span class="keyword">new</span> LinuxAppCommand(sshConfigDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LinuxAppCommand</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(sshConfigDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">buildExecuteCommands</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不是所有命令都需要 /bin/bash -c</span></span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;source /etc/profile &amp;&amp; source ~/.bash_profile &amp;&amp; source ~/.bashrc;&quot;</span> + command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getServerFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;server.sh&quot;</span>);</span><br><span class="line">        String serverFilePath = serverPath.toString().replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> checkShellFileCanExecute = checkShellFileCanExecute(serverFilePath);</span><br><span class="line">        <span class="keyword">if</span> (!checkShellFileCanExecute) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BizException(<span class="string">&quot;server.sh 不具备可执行权限！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serverFilePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getPidFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;shutdown.pid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverPath.toString().replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 构建命令 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartProcessCommand</span><span class="params">(AppConfigDTO appConfigDTO, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getServerFilePath(appConfigDTO) + <span class="string">&quot; start&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildKillCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;kill /pid &quot;</span> + pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetProcessMemoryCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 返回数值单位kb</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;cat /proc/&quot;</span> + pid + <span class="string">&quot;/smaps | grep &#x27;^Rss:&#x27; | awk &#x27;&#123;sum +=$2&#125; END&#123;print sum&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPortCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;netstat -anp | grep &#x27;LISTEN&#x27; | grep &#x27; &quot;</span> + pid + <span class="string">&quot;/&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPidCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            String serviceName = StrUtil.addSuffixIfNot(appConfigDTO.getServiceName(), <span class="string">&quot;.service&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;test -n \&quot;$(systemctl --state=running --type=service | grep %s)\&quot; &amp;&amp; systemctl status %s | grep &#x27;Main PID&#x27; | awk &#x27;&#123;print $3&#125;&#x27;&quot;</span>, serviceName, serviceName);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (appConfigDTO.isJavaDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;jps -vm | grep %s | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, appConfigDTO.getAppPath());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ps -ef | grep &#x27;&quot;</span> + appConfigDTO.getAppName() + <span class="string">&quot;&#x27; | grep -v &#x27;grep&#x27; | awk &#x27;&#123;print $2&#125;&#x27;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;systemctl start &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> buildStartProcessCommand(appConfigDTO, sshConfigDTO);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;systemctl stop &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; stop&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildRestartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;systemctl restart &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; restart&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildTailFileCommand</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tail -n 50 -f &quot;</span> + filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopTailFileCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ps -aux | grep -v grep | grep &#x27;&quot;</span> + buildTailFileCommand(appConfigDTO.getAppAllLogPath()) + <span class="string">&quot;&#x27; | awk &#x27;&#123;print $2&#125;&#x27; | xargs kill&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 进程、服务相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String pidFilePath = getPidFilePath(appConfigDTO);</span><br><span class="line">        <span class="keyword">if</span> (fileExist(pidFilePath)) &#123;</span><br><span class="line">            <span class="keyword">int</span> pid = Integer.parseInt(getFileContent(pidFilePath));</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtil.isNotEmpty(getPort(pid))) &#123;</span><br><span class="line">                <span class="keyword">return</span> pid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String buildGetPidCommand = buildGetPidCommand(appConfigDTO);</span><br><span class="line">        String result = execSystemCommand(buildGetPidCommand);</span><br><span class="line">        <span class="keyword">return</span> getPidNumber(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 系统相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">compressToZip</span><span class="params">(List&lt;String&gt; filePathList)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;name=&#x27;/tmp/&#x27;`cat /proc/sys/kernel/random/uuid` &amp;&amp; zip -qjr $name&#x27;.zip&#x27; &quot;</span> + String.join(<span class="string">&quot; &quot;</span>, filePathList) + <span class="string">&quot; &amp;&amp; echo $name&#x27;.zip&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;du -s &quot;</span> + filePath + <span class="string">&quot; | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(execSystemCommand(command));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFileMd5</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;test -f %s &amp;&amp; md5sum %s | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, filePath, filePath);</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMemoryUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 82.6577</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;cat /proc/meminfo | grep -E &#x27;^MemT|^MemF|^Buffers|^Cached&#x27; | awk -F&#x27; &#x27; &#x27;&#123;print $2&#125;&#x27; | awk &#x27;&#123;printf \&quot;%s \&quot;, $1&#125;&#x27; | awk &#x27;&#123;print ($1-$2-$3-$4)/$1*100&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getCpuUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 3.2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123; cat /proc/stat; sleep \&quot;1\&quot;; cat /proc/stat; &#125; | awk &#x27;/^cpu / &#123;usr=$2-usr; sys=$4-sys; idle=$5-idle; iow=$6-iow&#125; END &#123;total=usr+sys+idle+iow; printf (total-idle)/total*100&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDiskUsedRateCommand</span><span class="params">(List&lt;String&gt; mountedDir)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根目录挂载点 96.1242</span></span><br><span class="line">        String regex = mountedDir.stream().map(dir -&gt; dir + <span class="string">&quot;$&quot;</span>).collect(Collectors.joining(<span class="string">&quot;|&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;df | grep -E &#x27;&quot;</span> + regex + <span class="string">&quot;&#x27; | awk &#x27;BEGIN&#123;total=0;used=0&#125;&#123;total+=$2;used+=$3&#125;END &#123;print used/total*100&#125;&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFileContent</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        filePath = filePath.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        String command = <span class="string">&quot;cat &quot;</span> + filePath;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeFileContent</span><span class="params">(String content, String filePath, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        filePath = filePath.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        String command = <span class="string">&quot;echo &#x27;&quot;</span> + content.replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&#x27;\&quot;&#x27;\&quot;&#x27;&quot;</span>) + <span class="string">&quot;&#x27; &gt; &quot;</span> + filePath;</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// cp -fr /home/a/* /home/b</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;/bin/cp -fr %s %s&quot;</span>, sourcePath, targetPath);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> fileExist(targetPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// mv -f /home/a/* /home/b</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;/bin/mv -f %s %s&quot;</span>, sourcePath, targetPath);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> fileExist(targetPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fileExist</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;if [ -e &#x27;&quot;</span> + filePath + <span class="string">&quot;&#x27; ]; then echo 1; fi&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteFile</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;rm -f &quot;</span> + filePath;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.isBlank(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(String dirPath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;rm -rf &quot;</span> + dirPath;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.isBlank(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">chmod</span><span class="params">(String filePath, String params)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;/bin/chmod &quot;</span> + params + <span class="string">&quot; &quot;</span> + filePath;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.isBlank(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listDir</span><span class="params">(String dirPath, String keyword, <span class="keyword">boolean</span> recursive)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;find &#x27;%s&#x27; %s -name &#x27;*%s*&#x27;&quot;</span>, dirPath, recursive ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;-maxdepth 1&quot;</span>, keyword);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> CharSequenceUtil.splitTrim(result, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 start</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enableFirewall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --state&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;running&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PortDTO&gt; <span class="title">listPorts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 开放端口</span></span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --zone=public --list-ports | awk &#x27;BEGIN&#123;cmd=\&quot;\&quot;&#125;&#123;for(i=1;i&lt;=NF;i++) &#123;split($i,a,\&quot;/\&quot;); port=a[1]; protocol=a[2]; cmd=\&quot;netstat -tunlp | grep \&quot;port \&quot; | wc -l\&quot;; cmd | getline num; print a[1],a[2],num; &#125;&#125;&#x27;&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        List&lt;PortDTO&gt; list = StrUtil.splitTrim(result, <span class="string">&quot;\n&quot;</span>).stream().map(text -&gt; &#123;</span><br><span class="line">            String[] strings = text.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> port = Integer.parseInt(strings[<span class="number">0</span>]);</span><br><span class="line">            String protocol = strings[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">boolean</span> used = Integer.parseInt(strings[<span class="number">2</span>]) &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PortDTO(port, used, protocol);</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定ip开放端口</span></span><br><span class="line">        command = <span class="string">&quot;firewall-cmd --zone=public --list-rich-rules&quot;</span>;</span><br><span class="line">        result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(result)) &#123;</span><br><span class="line">            List&lt;PortDTO&gt; richRules = StrUtil.splitTrim(result, <span class="string">&quot;\n&quot;</span>).stream().map(text -&gt; &#123;</span><br><span class="line">                List&lt;String&gt; strings = ReUtil.getAllGroups(Pattern.compile(<span class="string">&quot;rule family=\&quot;ipv4\&quot; source address=\&quot;(.*?)\&quot; port port=\&quot;(.*?)\&quot; protocol=\&quot;(.*?)\&quot; accept&quot;</span>), text, <span class="keyword">false</span>);</span><br><span class="line">                String ip = strings.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> port = Integer.parseInt(strings.get(<span class="number">1</span>));</span><br><span class="line">                String protocol = strings.get(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">boolean</span> used = Integer.parseInt(strings.get(<span class="number">1</span>)) &gt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PortDTO(ip, port, used, protocol);</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            list.addAll(richRules);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listRichRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --zone=public --permanent --add-port=&quot;</span> + port + <span class="string">&quot;/tcp &amp;&amp; firewall-cmd --reload&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPortToIp</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=%s port protocol=tcp port=%s accept&#x27; &amp;&amp; firewall-cmd --reload&quot;</span>, ip, port);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --permanent --add-rich-rule=&#x27;rule family=ipv4 source address=&quot;</span> + ip + <span class="string">&quot; reject&#x27;&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;firewall-cmd --zone=public --permanent --remove-port=&quot;</span> + port + <span class="string">&quot;/tcp &amp;&amp; firewall-cmd --reload&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIpPort</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;firewall-cmd --permanent --remove-rich-rule=&#x27;rule family=ipv4 source address=%s port protocol=tcp port=%s accept&#x27; &amp;&amp; firewall-cmd --reload&quot;</span>, ip, port);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> result.contains(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 end</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="WindowsAppCommand"><a href="#WindowsAppCommand" class="headerlink" title="WindowsAppCommand"></a>WindowsAppCommand</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haigui.<span class="keyword">module</span>.operation.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.SimpleCache;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.AppConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.dal.dto.SshConfigDTO;</span><br><span class="line"><span class="keyword">import</span> com.haigui.<span class="keyword">module</span>.operation.service.dto.PortDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JIAHE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowsAppCommand</span> <span class="keyword">extends</span> <span class="title">AbstractAppCommand</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">&quot;bat&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleCache&lt;String, WindowsAppCommand&gt; cache = <span class="keyword">new</span> SimpleCache&lt;&gt;(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WindowsAppCommand <span class="title">getInstance</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        String cacheKey = getCacheKey.apply(sshConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> cache.get(cacheKey, () -&gt; <span class="keyword">new</span> WindowsAppCommand(sshConfigDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WindowsAppCommand</span><span class="params">(SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(sshConfigDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">buildExecuteCommands</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;chcp 65001;&quot;</span>, command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getServerFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;server.bat&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverPath.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getPidFilePath</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appPath = appConfigDTO.getAppPath();</span><br><span class="line">        Path serverPath = Paths.get(appPath, <span class="string">&quot;bin&quot;</span>, <span class="string">&quot;shutdown.pid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverPath.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 构建命令 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartProcessCommand</span><span class="params">(AppConfigDTO appConfigDTO, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">        <span class="keyword">return</span> serverFilePath + <span class="string">&quot; start&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildKillCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(</span><br><span class="line">                <span class="string">&quot;$ParentPid=((Get-CimInstance Win32_Process -Filter &#x27;ProcessId = %s&#x27;).ParentProcessId);&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if ($ParentPid) &#123; Stop-Process -Id $ParentPid; &#125;; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;$Process=(Get-Process -PID %s -ErrorAction SilentlyContinue); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if ($Process) &#123; Stop-Process -Id $Process.Id; &#125;&quot;</span>, pid, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetProcessMemoryCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 返回数值单位kb</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;((Get-Process -Id &quot;</span> + pid + <span class="string">&quot;).WorkingSet64 / 1024)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPortCommand</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;netstat -nao -p tcp | findstr \&quot;LISTENING\&quot; | findstr &quot;</span> + pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildGetPidCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String appName = appConfigDTO.getAppName();</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isJavaDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;$cmds = @&#123;&#125;; Get-CimInstance Win32_Process | %&#123; $cmds[$_.ProcessId.ToString()] = $_.CommandLine; &#125;;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;(Get-Process | Where-Object &#123;$_.Name -eq &#x27;java&#x27;&#125; | Select-Object Id,@&#123;Name=&#x27;CommandLine&#x27;;Expression=&#123;$cmds[$_.Id.ToString()]&#125;&#125; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot; | Where-Object &#123;($_.CommandLine -notlike &#x27;*$cmds*&#x27;) -and ($_.CommandLine -match &#x27;&quot;</span> + appName + <span class="string">&quot;&#x27;)&#125;).Id&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;$cmds = @&#123;&#125;; Get-CimInstance Win32_Process | %&#123; $cmds[$_.ProcessId.ToString()] = $_.CommandLine; &#125;;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;(Get-Process | Select-Object Id,@&#123;Name=&#x27;CommandLine&#x27;;Expression=&#123;$cmds[$_.Id.ToString()]&#125;&#125; &quot;</span> +</span><br><span class="line">                    <span class="string">&quot; | Where-Object &#123;($_.CommandLine -notlike &#x27;*$cmds*&#x27;) -and ($_.CommandLine -match &#x27;&quot;</span> + appName + <span class="string">&quot;&#x27;)&#125;).Id&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;net start &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> buildStartProcessCommand(appConfigDTO, sshConfigDTO);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;net stop &quot;</span> + appConfigDTO.getServiceName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; stop&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildRestartServiceCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appConfigDTO.isServiceDeploy()) &#123;</span><br><span class="line">            String serviceName = appConfigDTO.getServiceName();</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;net stop %s &amp;&amp; net start %s&quot;</span>, serviceName, serviceName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String serverFilePath = getServerFilePath(appConfigDTO);</span><br><span class="line">            <span class="keyword">return</span> serverFilePath + <span class="string">&quot; restart&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildTailFileCommand</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;chcp 65001; Get-Content -Encoding utf8 -Path &quot;</span> + cleanPath(filePath) + <span class="string">&quot; -Tail 50 -Wait&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">buildStopTailFileCommand</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Get-Process -Name pwsh | Where-Object &#123;$_.CommandLine -match &#x27;&quot;</span> + appConfigDTO.getAppAllLogPath() + <span class="string">&quot;&#x27;&#125; | Stop-Process&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 进程、服务相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">(AppConfigDTO appConfigDTO)</span> </span>&#123;</span><br><span class="line">        String buildGetPidCommand = buildGetPidCommand(appConfigDTO);</span><br><span class="line">        String result = execSystemCommand(buildGetPidCommand);</span><br><span class="line">        <span class="keyword">return</span> getPidNumber(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 系统相关 */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">compressToZip</span><span class="params">(List&lt;String&gt; filePathList)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// $uuid = (New-Guid).Guid; (Compress-Archive -Update -LiteralPath &#x27;%s&#x27; -DestinationPath &quot;~/$uuid.zip&quot; &amp;&amp; Resolve-Path &quot;~/$uuid.zip&quot;).Path</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;$uuid = (New-Guid).Guid; (Compress-Archive -Update -LiteralPath &#x27;%s&#x27; -DestinationPath \&quot;~/$uuid.zip\&quot; &amp;&amp; Resolve-Path \&quot;~/$uuid.zip\&quot;).Path&quot;</span>,</span><br><span class="line">                String.join(<span class="string">&quot;&#x27;, &#x27;&quot;</span>, cleanPath(filePathList)));</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getFileSize</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// (Get-ChildItem -Path C:\qingting -Force -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum</span></span><br><span class="line">        String command = <span class="string">&quot;[int]((Get-ChildItem -Path &quot;</span> + cleanPath(filePath) + <span class="string">&quot; -Force -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum / 1024)&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(execSystemCommand(command));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFileMd5</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;(Get-FileHash &quot;</span> + cleanPath(filePath) + <span class="string">&quot; -Algorithm MD5).Hash&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMemoryUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 38.6184856473571</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;$mem = Get-CIMInstance Win32_OperatingSystem; ($mem.TotalVisibleMemorySize - $mem.FreePhysicalMemory) / $mem.TotalVisibleMemorySize * 100&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getCpuUsedRateCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Get-CimInstance win32_processor | Measure-Object LoadPercentage -Average | ft -h Average&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDiskUsedRateCommand</span><span class="params">(List&lt;String&gt; mountedDir)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 29.2729359900061</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;powershell; $disk = Get-CimInstance win32_logicaldisk; ($disk.Size - $disk.FreeSpace) / $disk.Size * 100&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getFileContent</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;Get-Content -Encoding utf8 -Path &#x27;&quot;</span> + cleanPath(filePath) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeFileContent</span><span class="params">(String content, String filePath, SshConfigDTO sshConfigDTO)</span> </span>&#123;</span><br><span class="line">        content = content.replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\&quot;\&quot;&quot;</span>);</span><br><span class="line">        String command = String.format(<span class="string">&quot;Set-Content -Encoding utf8 -Path &#x27;%s&#x27; -Value \&quot;%s\&quot;&quot;</span>, cleanPath(filePath), content);</span><br><span class="line">        execSystemCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Copy-Item -Recurse -Path &#x27;.\backup\1639120640510\*&#x27; -Destination &#x27;.\lib\&#x27;</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;Copy-Item -Recurse -Path &#x27;%s&#x27; -Destination &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(sourcePath), cleanPath(targetPath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(String sourcePath, String targetPath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;Move-Item -Path &#x27;%s&#x27; -Destination &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(sourcePath), cleanPath(targetPath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fileExist</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;Test-Path &#x27;&quot;</span> + cleanPath(filePath) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;True&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteFile</span><span class="params">(String filePath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;Remove-Item -Force -Path &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(filePath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteDir</span><span class="params">(String dirPath)</span> </span>&#123;</span><br><span class="line">        String command = String.format(<span class="string">&quot;Remove-Item -Force -Recurse -Path &#x27;%s&#x27; &amp;&amp; echo 1&quot;</span>, cleanPath(dirPath));</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>.equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">chmod</span><span class="params">(String filePath, String params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listDir</span><span class="params">(String dirPath, String keyword, <span class="keyword">boolean</span> recursive)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// (Get-ChildItem -Recurse -Path . -Filter *pdf* -ErrorAction SilentlyContinue -Force | Resolve-Path -Relative | Resolve-Path).Path</span></span><br><span class="line">        String command = String.format(<span class="string">&quot;(Get-ChildItem -Path &#x27;%s&#x27; -Filter *%s* -ErrorAction SilentlyContinue -Force %s | Resolve-Path -Relative | Resolve-Path).Path&quot;</span>,</span><br><span class="line">                cleanPath(dirPath), keyword, recursive ? <span class="string">&quot;-Relative&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">        String result = execSystemCommand(command);</span><br><span class="line">        <span class="keyword">return</span> StrUtil.splitTrim(result, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 start</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enableFirewall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PortDTO&gt; <span class="title">listPorts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listRichRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openPortToIp</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limitIpPort</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================================================================================================== 防火墙 end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">cleanPath</span><span class="params">(List&lt;String&gt; paths)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paths.stream().map(path -&gt; StrUtil.removePrefix(path, <span class="string">&quot;/&quot;</span>)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">cleanPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StrUtil.removePrefix(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang=""><link itemprop="mainEntityOfPage" href="http://xiaojianzheng.cn/2022/09/07/%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D%E4%BD%BF%E7%94%A8scoop/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="JIAHE"><meta itemprop="description" content="Collection & Reuse"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="JIAHE"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/09/07/%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E5%90%8E%E5%A6%82%E4%BD%95%E6%81%A2%E5%A4%8D%E4%BD%BF%E7%94%A8scoop/" class="post-title-link" itemprop="url">重装系统后如何恢复使用scoop</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-07 18:05:26" itemprop="dateCreated datePublished" datetime="2022-09-07T18:05:26+08:00">2022-09-07</time></span></div></div></header><div class="post-body" itemprop="articleBody"><p>重装系统之后, 如果把原有的scoop文件夹粘贴回去user文件夹,然后在powershell中再次输入Windows下的软件管理神器:scoop文章中的安装命令,会得到一个Scoop is already installed错误,要想正确恢复scoop,根据官方回答,请按照以下步骤:</p><ol><li><p>重装系统之前,先完整复制用户目录下的scoop文件夹到别的地方</p></li><li><p>重装系统之后,将scoop文件夹粘贴回去用户目录</p></li><li><p>在环境变量设置中,新建一个用户变量,名字为SCOOP,值为当前scoop文件夹的地址</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\xxx\scoop</span><br></pre></td></tr></table></figure></li><li><p>允许脚本执行</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set-executionpolicy remotesigned -s currentuser</span><br></pre></td></tr></table></figure></li><li><p>双击用户变量中的path,新建一个路径,填入</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%SCOOP%\shims</span><br></pre></td></tr></table></figure></li><li><p>管理员权限powershell中运行</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scoop reset *</span><br></pre></td></tr></table></figure></li><li><p>即可恢复所有软件的正常使用</p></li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">湘ICP备19011756号-1</a></div><div class="copyright"> &copy; 2021 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">JIAHE</span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.2.7/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script><script src="/js/third-party/tags/pdf.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"ignores":null,"url":"http://xiaojianzheng.cn/"}</script><script src="/js/third-party/quicklink.js"></script><script>"use strict";"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(function(r){r.onupdatefound=function(){var e=r.installing;e.onstatechange=function(){switch(e.state){case"installed":navigator.serviceWorker.controller?console.log("New or updated content is available."):console.log("Content is now available offline!");break;case"redundant":console.error("The installing service worker became redundant.")}}}}).catch(function(e){console.error("Error during service worker registration:",e)})</script></body></html>