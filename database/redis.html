<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;xiaojianzheng.cn&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:true,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:true,&quot;pangu&quot;:true,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:true,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:true}}</script><script src="/js/config.js"></script>
<meta name="description" content="一、概述Redis 是速度非常快的非关系型（NoSQL）内存键值数据库，可以存储键和五种不同类型的值之间的映射。 键的类型只能为字符串，值支持五种数据类型：字符串、列表、集合、散列表、有序集合。 Redis 支持很多特性，例如将内存中的数据持久化到硬盘中，使用复制来扩展读性能，使用分片来扩展写性能。 二、数据类型   数据类型 可以存储的值 操作    STRING 字符串、整数或者浮点数 对整个">
<meta property="og:type" content="website">
<meta property="og:title" content="JIAHE">
<meta property="og:url" content="https://xiaojianzheng.cn/database/redis.html">
<meta property="og:site_name" content="JIAHE">
<meta property="og:description" content="一、概述Redis 是速度非常快的非关系型（NoSQL）内存键值数据库，可以存储键和五种不同类型的值之间的映射。 键的类型只能为字符串，值支持五种数据类型：字符串、列表、集合、散列表、有序集合。 Redis 支持很多特性，例如将内存中的数据持久化到硬盘中，使用复制来扩展读性能，使用分片来扩展写性能。 二、数据类型   数据类型 可以存储的值 操作    STRING 字符串、整数或者浮点数 对整个">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/6019b2db-bc3e-4408-b6d8-96025f4481d6.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/fb327611-7e2b-4f2f-9f5b-38592d408f07.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cd5fbcff-3f35-43a6-8ffa-082a93ce0f0e.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7bd202a7-93d4-4f3a-a878-af68ae25539a.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1202b2d6-9469-4251-bd47-ca6034fb6116.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/beba612e-dc5b-4fc2-869d-0b23408ac90a.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/0ea37ee2-c224-4c79-b895-e131c6805c40.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9ea86eb5-000a-4281-b948-7b567bd6f1d8.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/c0a9fa91-da2e-4892-8c9f-80206a6f7047.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/395a9e83-b1a1-4a1d-b170-d081e7bb5bab.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7c54de21-e2ff-402e-bc42-4037de1c1592.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/485fdf34-ccf8-4185-97c6-17374ee719a0.png">
<meta property="og:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f7d170a3-e446-4a64-ac2d-cb95028f81a8.png">
<meta property="article:published_time" content="2021-06-21T06:57:56.781Z">
<meta property="article:modified_time" content="2021-06-21T06:57:56.781Z">
<meta property="article:author" content="JIAHE">
<meta property="article:tag" content="JIAHE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/6019b2db-bc3e-4408-b6d8-96025f4481d6.png">


<link rel="canonical" href="https://xiaojianzheng.cn/database/redis">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;xiaojianzheng.cn&#x2F;database&#x2F;redis.html&quot;,&quot;path&quot;:&quot;database&#x2F;redis.html&quot;,&quot;title&quot;:&quot;&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title> | JIAHE
</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">JIAHE</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-navigation"><a href="/navigation/" rel="section"><i class="fa fa-location-arrow fa-fw"></i>navigation</a></li>
        <li class="menu-item menu-item-巨人的肩膀"><a href="/experience/" rel="section"><i class="fa fa-lightbulb fa-fw"></i>巨人的肩膀</a></li>
        
            
  <li class="menu-item menu-item-java"><a href="/java/" rel="section"><i class="fa fa-code fa-fw"></i>Java</a></li>


      
        
            
  <li class="menu-item menu-item-spring全家桶"><a href="/spring-framework/" rel="section"><i class="fa fa-code fa-fw"></i>Spring全家桶</a></li>


      
        <li class="menu-item menu-item-代码可读性"><a href="/code-easy-read/" rel="section"><i class="far fa-file-code fa-fw"></i>代码可读性</a></li>
        
            
  <li class="menu-item menu-item-数据库"><a href="/database/" rel="section"><i class="fas fa-database fa-fw"></i>数据库</a></li>


      
        
            
  <li class="menu-item menu-item-计算机网络"><a href="/network/" rel="section"><i class="fas fa-network-wired fa-fw"></i>计算机网络</a></li>


      
        
            
  <li class="menu-item menu-item-操作系统基础"><a href="/os/" rel="section"><i class="fas fa-laptop fa-fw"></i>操作系统基础</a></li>


      
        
            
  <li class="menu-item menu-item-基础概念"><a href="/basic-concepts/" rel="section"><i class="fas fa-star fa-fw"></i>基础概念</a></li>


      
        
            
  <li class="menu-item menu-item-数据结构与算法"><a href="/data-structure/" rel="section"><i class="fas fa-poll fa-fw"></i>数据结构与算法</a></li>


      
        <li class="menu-item menu-item-git基础"><a href="/git-basics/" rel="section"><i class="fab fa-git-alt fa-fw"></i>Git基础</a></li>
        <li class="menu-item menu-item-vim-cheat-sheet"><a href="/vim-cheat-sheet/" rel="section"><i class="fab fa-vimeo-square fa-fw"></i>Vim Cheat Sheet</a></li>
        <li class="menu-item menu-item-常用软件"><a href="/windows-software-cheat-sheet/" rel="section"><i class="fab fa-windows fa-fw"></i>常用软件</a></li>
        <li class="menu-item menu-item-html元素参考"><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element" rel="noopener" target="_blank"><i class="fab fa-html5 fa-fw"></i>HTML元素参考</a></li>
        <li class="menu-item menu-item-css-参考"><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference" rel="noopener" target="_blank"><i class="fab fa-css3-alt fa-fw"></i>CSS 参考</a></li>
        <li class="menu-item menu-item-javascript-参考"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference" rel="noopener" target="_blank"><i class="fab fa-js-square fa-fw"></i>JavaScript 参考</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.</span> <span class="nav-text">二、数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#STRING"><span class="nav-number">2.1.</span> <span class="nav-text">STRING</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81"><span class="nav-number">2.1.1.</span> <span class="nav-text">内部编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.1.2.</span> <span class="nav-text">典型使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LIST"><span class="nav-number">2.2.</span> <span class="nav-text">LIST</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9"><span class="nav-number">2.2.1.</span> <span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-1"><span class="nav-number">2.2.2.</span> <span class="nav-text">内部编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.2.3.</span> <span class="nav-text">典型应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SET"><span class="nav-number">2.3.</span> <span class="nav-text">SET</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-2"><span class="nav-number">2.3.2.</span> <span class="nav-text">内部编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-number">2.3.3.</span> <span class="nav-text">内存优化技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="nav-number">2.3.4.</span> <span class="nav-text">典型应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HASH"><span class="nav-number">2.4.</span> <span class="nav-text">HASH</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-3"><span class="nav-number">2.4.1.</span> <span class="nav-text">内部编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7-1"><span class="nav-number">2.4.2.</span> <span class="nav-text">内存优化技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="nav-number">2.4.3.</span> <span class="nav-text">典型应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZSET"><span class="nav-number">2.5.</span> <span class="nav-text">ZSET</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-2"><span class="nav-number">2.5.1.</span> <span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%BC%96%E7%A0%81-4"><span class="nav-number">2.5.2.</span> <span class="nav-text">内部编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-3"><span class="nav-number">2.5.3.</span> <span class="nav-text">典型应用场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">三、数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E5%85%B8"><span class="nav-number">3.1.</span> <span class="nav-text">字典</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%B3%E8%B7%83%E8%A1%A8"><span class="nav-number">3.2.</span> <span class="nav-text">跳跃表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.</span> <span class="nav-text">四、使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">4.1.</span> <span class="nav-text">计数器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-number">4.2.</span> <span class="nav-text">缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E8%A1%A8"><span class="nav-number">4.3.</span> <span class="nav-text">查找表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">4.4.</span> <span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E7%BC%93%E5%AD%98"><span class="nav-number">4.5.</span> <span class="nav-text">会话缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.6.</span> <span class="nav-text">分布式锁实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E5%AE%83"><span class="nav-number">4.7.</span> <span class="nav-text">其它</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Redis-%E4%B8%8E-Memcached"><span class="nav-number">5.</span> <span class="nav-text">五、Redis 与 Memcached</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.1.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">5.2.</span> <span class="nav-text">数据持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="nav-number">5.3.</span> <span class="nav-text">分布式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-number">5.4.</span> <span class="nav-text">内存管理机制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E9%94%AE%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="nav-number">6.</span> <span class="nav-text">六、键的过期时间</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><span class="nav-number">7.</span> <span class="nav-text">七、数据淘汰策略</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">8.</span> <span class="nav-text">八、持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RDB-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">8.1.</span> <span class="nav-text">RDB 持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOF-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">8.2.</span> <span class="nav-text">AOF 持久化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E4%BA%8B%E5%8A%A1"><span class="nav-number">9.</span> <span class="nav-text">九、事务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E4%BA%8B%E4%BB%B6"><span class="nav-number">10.</span> <span class="nav-text">十、事件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6"><span class="nav-number">10.1.</span> <span class="nav-text">文件事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6"><span class="nav-number">10.2.</span> <span class="nav-text">时间事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%B0%83%E5%BA%A6%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="nav-number">10.3.</span> <span class="nav-text">事件的调度与执行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%A4%8D%E5%88%B6"><span class="nav-number">11.</span> <span class="nav-text">十一、复制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B"><span class="nav-number">11.1.</span> <span class="nav-text">连接过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E9%93%BE"><span class="nav-number">11.2.</span> <span class="nav-text">主从链</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81Sentinel"><span class="nav-number">12.</span> <span class="nav-text">十二、Sentinel</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E5%88%86%E7%89%87"><span class="nav-number">13.</span> <span class="nav-text">十三、分片</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E8%AE%BA%E5%9D%9B%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90"><span class="nav-number">14.</span> <span class="nav-text">十四、一个简单的论坛系统分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E7%AB%A0%E4%BF%A1%E6%81%AF"><span class="nav-number">14.1.</span> <span class="nav-text">文章信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="nav-number">14.2.</span> <span class="nav-text">点赞功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E6%96%87%E7%AB%A0%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F"><span class="nav-number">14.3.</span> <span class="nav-text">对文章进行排序</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">15.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">JIAHE</p>
  <div class="site-description" itemprop="description">Collection & Reuse</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner page posts-expand">
  

      
      

      
      

      

        
        <ul class="sub-menu menu">
          
            
          
          
              
  <li class="menu-item menu-item-sql语法"><a href="/database/index.html" rel="section">SQL语法</a></li>


          
          
              
  <li class="menu-item menu-item-数据库系统原理"><a href="/database/database-system.html" rel="section">数据库系统原理</a></li>


          
          
              
  <li class="menu-item menu-item-mysql"><a href="/database/mysql.html" rel="section">MySQL</a></li>


          
          
              
  <li class="menu-item menu-item-redis"><a href="/database/redis.html" rel="section">Redis</a></li>


          
        </ul>
        

        
        
      

      
      

      
      

      
      

      
      
  


    
    
    
    <div class="post-block" lang="zh-CN"><header class="post-header">

<h1 class="post-title" itemprop="name headline">
</h1>

<div class="post-meta-container">
</div>

</header>

      
      
      <div class="post-body">
          <h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>Redis 是速度非常快的非关系型（NoSQL）内存键值数据库，可以存储键和五种不同类型的值之间的映射。</p>
<p>键的类型只能为字符串，值支持五种数据类型：字符串、列表、集合、散列表、有序集合。</p>
<p>Redis 支持很多特性，例如将内存中的数据持久化到硬盘中，使用复制来扩展读性能，使用分片来扩展写性能。</p>
<h1 id="二、数据类型"><a href="#二、数据类型" class="headerlink" title="二、数据类型"></a>二、数据类型</h1><table>
<thead>
<tr>
<th align="center">数据类型</th>
<th align="center">可以存储的值</th>
<th align="center">操作</th>
</tr>
</thead>
<tbody><tr>
<td align="center">STRING</td>
<td align="center">字符串、整数或者浮点数</td>
<td align="center">对整个字符串或者字符串的其中一部分执行操作</br> 对整数和浮点数执行自增或者自减操作</td>
</tr>
<tr>
<td align="center">LIST</td>
<td align="center">列表</td>
<td align="center">从两端压入或者弹出元素 </br> 对单个或者多个元素进行修剪，</br> 只保留一个范围内的元素</td>
</tr>
<tr>
<td align="center">SET</td>
<td align="center">无序集合</td>
<td align="center">添加、获取、移除单个元素</br> 检查一个元素是否存在于集合中</br> 计算交集、并集、差集</br> 从集合里面随机获取元素</td>
</tr>
<tr>
<td align="center">HASH</td>
<td align="center">包含键值对的无序散列表</td>
<td align="center">添加、获取、移除单个键值对</br> 获取所有键值对</br> 检查某个键是否存在</td>
</tr>
<tr>
<td align="center">ZSET</td>
<td align="center">有序集合</td>
<td align="center">添加、获取、删除元素</br> 根据分值范围或者成员来获取元素</br> 计算一个键的排名</td>
</tr>
</tbody></table>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://redislabs.com/ebook/part-1-getting-started/chapter-1-getting-to-know-redis/1-2-what-redis-data-structures-look-like/">What Redis data structures look like(opens new window)</a></p>
</blockquote>
<h2 id="STRING"><a href="#STRING" class="headerlink" title="STRING"></a>STRING</h2><p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/6019b2db-bc3e-4408-b6d8-96025f4481d6.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/set.html">SET</a> <code>SET key value [EX seconds] [PX milliseconds] [NX|XX]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/setnx.html">SETNX</a> <code>SETNX key value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/setex.html">SETEX</a> <code>SETEX key seconds value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/psetex.html">PSETEX</a> <code>PSETEX key milliseconds value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/get.html">GET</a> <code>GET key</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/getset.html">GETSET</a> <code>GETSET key value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/strlen.html">STRLEN</a> <code>STRLEN key</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/append.html">APPEND</a> <code>APPEND key value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/setrange.html">SETRANGE</a> <code>SETRANGE key offset value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/getrange.html">GETRANGE</a> <code>GETRANGE key start end</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/incr.html">INCR</a> <code>INCR key</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/incrby.html">INCRBY</a> <code>INCRBY key increment</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/incrbyfloat.html">INCRBYFLOAT</a> <code>INCRBYFLOAT key increment</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/decr.html">DECR</a> <code>DECR key</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/decrby.html">DECRBY</a> <code>DECRBY key decrement</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/mset.html">MSET</a> <code>MSET key value [key value …]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/msetnx.html">MSETNX</a> <code>MSETNX key value [key value …]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/string/mget.html">MGET</a> <code>MGET key [key …]</code></li>
</ul>
<h3 id="内部编码"><a href="#内部编码" class="headerlink" title="内部编码"></a>内部编码</h3><p>Redis会根据当前值得到类型和长度决定使用哪种内部编码实现。</p>
<ul>
<li>int 小于8字节的长整型</li>
<li>embstr 小于等于39字节的字符串</li>
<li>raw 大于39字节的字符串</li>
</ul>
<h3 id="典型使用场景"><a href="#典型使用场景" class="headerlink" title="典型使用场景"></a>典型使用场景</h3><ol>
<li><p>缓存功能<br>将Redis作为缓存层，MySQL作为存储层，绝大部分请求的数据优先从Redis中获取。（注意：key的设计，过期时间的设置）</p>
</li>
<li><p>计数统计<br>实际一个真是的技术系统要考虑的问题会很多：防作弊、按照不同维度计数、数据持久化到底层数据源等。</p>
</li>
<li><p>共享Session<br>将Redis作为分布式服务下的Session存储服务，避免同一用户的请求被负载均衡到不同的服务器上时需要重新登录的问题。</p>
</li>
<li><p>限速<br>同样是通过计数功能，可以限制指定功能接口的请求频率。</p>
</li>
</ol>
<h2 id="LIST"><a href="#LIST" class="headerlink" title="LIST"></a>LIST</h2><p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/fb327611-7e2b-4f2f-9f5b-38592d408f07.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lpush.html">LPUSH</a> <code>LPUSH key value [value …]</code> 从左边插入元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lpushx.html">LPUSHX</a> <code>LPUSHX key value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpush.html">RPUSH</a> <code>RPUSH key value [value …]</code> 从右边新增元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpushx.html">RPUSHX</a> <code>RPUSHX key value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lpop.html">LPOP</a> <code>LPOP key</code> 从左边删除元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpop.html">RPOP</a> <code>RPOP key</code> 从右边删除元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/rpoplpush.html">RPOPLPUSH</a> <code>RPOPLPUSH source destination</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lrem.html">LREM</a> <code>LREM key count value</code> 删除指定元素，count&gt;0 则从左到右删除count个，count&lt;0 则从右到左删除，count=0 则删除所有</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/llen.html">LLEN</a> <code>LLEN key</code> 获取列表长度</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lindex.html">LINDEX</a> <code>LINDEX key index</code> 获取指定索引下标的元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/linsert.html">LINSERT</a> <code>LINSERT key BEFORE|AFTER pivot value</code> 向某个元素前或者后插入元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lset.html">LSET</a> <code>LSET key index value</code> 修改指定索引下标的元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/lrange.html">LRANGE</a> <code>LRANGE key start stop</code> 获取指定范围内的元素列表</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/ltrim.html">LTRIM</a> <code>LTRIM key start stop</code> 只保留指定范围的元素，其余元素删除</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/blpop.html">BLPOP</a> <code>BLPOP key [key …] timeout</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/brpop.html">BRPOP</a> <code>BRPOP key [key …] timeout</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/list/brpoplpush.html">BRPOPLPUSH</a> <code>BRPOPLPUSH source destination timeout</code></li>
</ul>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol>
<li>列表中的元素是有序的</li>
<li>列表中的元素是可以重复的</li>
</ol>
<h3 id="内部编码-1"><a href="#内部编码-1" class="headerlink" title="内部编码"></a>内部编码</h3><ul>
<li>ziplist（压缩列表）当哈希类型元素个数小于<code>hash-max-ziplist-entries</code>配置（默512个）、同事所有值都小于<code>hash-max-ziplist-value</code>配置（默认64字节）时，Redis会使用ziplist作为哈希的内部实现，ziplist使用更加紧凑的结构实现多个元素的连续存储，所在节省内存方面比hashtable更加优秀。</li>
<li>linkedlist（链表）当列表类型无法满足ziplist的条件时，Redis会使用linkedlist作为列表的内部实现。</li>
<li>quicklist</li>
</ul>
<h3 id="典型应用场景"><a href="#典型应用场景" class="headerlink" title="典型应用场景"></a>典型应用场景</h3><ol>
<li>消息队列</li>
</ol>
<p>通过lpush+brpop命令组合即可实现阻塞队列，生产者使用lpush从列表左侧插入元素，消费者使用brpop命令阻塞式获取列表右侧的元素。</p>
<p>实际上列表的使用场景很多，在选择时可以参考一下口诀：</p>
<ul>
<li>lpush + lpop = Stack（栈）</li>
<li>lpush + rpop = Queue（队列）</li>
<li>lpush + ltrim = Capped Collection（有限集合）</li>
<li>lpush + brpop = Message Queue（消息队列）</li>
</ul>
<h2 id="SET"><a href="#SET" class="headerlink" title="SET"></a>SET</h2><p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cd5fbcff-3f35-43a6-8ffa-082a93ce0f0e.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sadd.html">SADD</a> <code>SADD key member [member …]</code> 添加元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sismember.html">SISMEMBER</a> <code>SISMEMBER key member</code> 判断元素是否在集合中，存在返回1，否则返回0</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/spop.html">SPOP</a> <code>SPOP key [count]</code> 从集合中随机弹出元素，会删除，count参数从3.2版本开始可用</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/srandmember.html">SRANDMEMBER</a> <code>SRANDMEMBER key [count]</code> 随机从集合中弹出指定个数元素，count默认为1，不会删除</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/srem.html">SREM</a> <code>SREM key member [member …]</code> 移除集合中的一个或多个元素，不存在的元素会被忽略</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/smove.html">SMOVE</a> <code>SMOVE source destination member</code> 将 member 元素从 source 集合移动到 destination 集合。</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/scard.html">SCARD</a> <code>SCARD key</code> 计算元素个数，时间复杂度为O(1)，因为是直接使用Redis内部的计数变量</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/smembers.html">SMEMBERS</a> <code>SMEMBERS key</code> 获取所有元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sscan.html">SSCAN</a> <code>SSCAN key cursor [MATCH pattern] [COUNT count]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sinter.html">SINTER</a> <code>SINTER key [key …]</code> 取多个集合的交集</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sinterstore.html">SINTERSTORE</a> <code>SINTERSTORE destination key [key …]</code> 将多个集合的交集结果保存到第一个key中</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sunion.html">SUNION</a> <code>SUNION key [key …]</code> 取多个集合的并集</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sunionstore.html">SUNIONSTORE</a> <code>SUNIONSTORE destination key [key …]</code> 将多个集合的并集结果保存到第一个key中</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sdiff.html">SDIFF</a> <code>SDIFF key [key …]</code> 取多个集合的差集</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/set/sdiffstore.html">SDIFFSTORE</a> <code>SDIFFSTORE destination key [key …]</code> 将多个集合的差集结果保存到第一个key中</li>
</ul>
<h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><ol>
<li>不允许有重复元素，且元素在集合中无序。</li>
<li>除了支持增删改查，还支持交集、并集和差集。</li>
</ol>
<h3 id="内部编码-2"><a href="#内部编码-2" class="headerlink" title="内部编码"></a>内部编码</h3><ul>
<li>intset（整数集合）当集合中的元素都是整数且元素个数小于<code>set-max-intset-entries</code>配置（默认512个）时，Redis会选用intset来作为集合的内部实现，从而减少内存的使用。</li>
<li>hashtable（哈希表）当即和类型无法满足intset的条件时，Redis会使用hashtable作为集合的内部实现</li>
</ul>
<h3 id="内存优化技巧"><a href="#内存优化技巧" class="headerlink" title="内存优化技巧"></a>内存优化技巧</h3><h3 id="典型应用场景-1"><a href="#典型应用场景-1" class="headerlink" title="典型应用场景"></a>典型应用场景</h3><ol>
<li>标签</li>
</ol>
<p>例如一个用户可能对游戏、音乐比较感兴趣，另一个用户可能对音乐、体育感兴趣，这些兴趣点就是标签；再例如博客中文章的关键词也可以作为一种标签。（用户和标签的关系维护应该在一个事务内执行，放至部分命令失败造成的数据不一致。可通过Lua脚本将两个命令放在一个事物中）</p>
<p>集合类型的应用场景通常为以下几种：</p>
<ul>
<li>sadd = Tagging（标签）</li>
<li>spop + srandmember = Random item（生成随机数，比如抽奖）</li>
<li>sadd + sinter = Social Graph（社交需求）</li>
</ul>
<h2 id="HASH"><a href="#HASH" class="headerlink" title="HASH"></a>HASH</h2><p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7bd202a7-93d4-4f3a-a878-af68ae25539a.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hset.html">HSET</a> <code>HSET hash field value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hsetnx.html">HSETNX</a> <code>HSETNX hash field value</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hget.html">HGET</a> <code>HGET hash field</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hexists.html">HEXISTS</a> <code>HEXISTS hash field</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hdel.html">HDEL</a> <code>HDEL</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hlen.html">HLEN</a> <code>HLEN</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hstrlen.html">HSTRLEN</a> <code>HSTRLEN</code> Redis3.2以上版本</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hincrby.html">HINCRBY</a> <code>HINCRBY</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hincrbyfloat.html">HINCRBYFLOAT</a> <code>HINCRBYFLOAT</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hmset.html">HMSET</a> <code>HMSET</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hmget.html">HMGET</a> <code>HMGET</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hkeys.html">HKEYS</a> <code>HKEYS</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hvals.html">HVALS</a> <code>HVALS</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hgetall.html">HGETALL</a> <code>HGETALL</code> <strong>谨慎使用</strong></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/hash/hscan.html">HSCAN</a> <code>HSCAN</code></li>
</ul>
<h3 id="内部编码-3"><a href="#内部编码-3" class="headerlink" title="内部编码"></a>内部编码</h3><ul>
<li>ziplist（压缩列表） 当哈希类型元素个数小于<code>hash-max-ziplist-entries</code>配置（默512个）、同事所有值都小于<code>hash-max-ziplist-value</code>配置（默认64字节）时，Redis会使用ziplist作为哈希的内部实现，ziplist使用更加紧凑的结构实现多个元素的连续存储，所在节省内存方面比hashtable更加优秀。</li>
<li>hashtable（哈希表）当哈希类型无法满足ziplist的条件时，Redis会使用hashtable作为哈希的内部实现，因为此时ziplist的读写效率会下降，而hashtable的读写时间复杂度为<code>O(1)</code>。</li>
</ul>
<h3 id="内存优化技巧-1"><a href="#内存优化技巧-1" class="headerlink" title="内存优化技巧"></a>内存优化技巧</h3><h3 id="典型应用场景-2"><a href="#典型应用场景-2" class="headerlink" title="典型应用场景"></a>典型应用场景</h3><ol>
<li>缓存用户信息</li>
</ol>
<p><strong>方法一：</strong>序列化字符串类型：将用户信息序列化后用一个键保存<br>优势：简化编程，如果理的使用序列化，可以提高内存的使用效率。<br>劣势：序列化和反序列化有一定的开销，同时每次更新属性都需要把全部属性取出进行反序列化，更新后再序列化到Redis中。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">set user:1 serialize(userInfo)</code></pre>

<p><strong>方法二：</strong>每个用户属性使用一对key-value，value中保存用户信息。<br>优势：简单直观，如果使用合理可以减少内存空间的使用。<br>劣势：要控制哈希在ziplist和hashtable两种内部编码的转换，hashtable会消耗更多的内存。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hmset user:1 name tom age 18 city changsha</code></pre>

<h2 id="ZSET"><a href="#ZSET" class="headerlink" title="ZSET"></a>ZSET</h2><p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1202b2d6-9469-4251-bd47-ca6034fb6116.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zadd.html">ZADD</a> <code>ZADD key score member [[score member] [score member] …]</code> 添加元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zscore.html">ZSCORE</a> <code>ZSCORE key member</code> 返回元素对应的score值</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zincrby.html">ZINCRBY</a> <code>ZINCRBY key increment member</code> 增加元素的score值</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zcard.html">ZCARD</a> <code>ZCARD key</code> 返回集合中元素个数</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zcount.html">ZCOUNT</a> <code>ZCOUNT key min max</code> 返回集合中元素的score值在[min, max]之间的元素个数</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrange.html">ZRANGE</a> <code>ZRANGE key start stop [WITHSCORES]</code> 返回指定索引范围内已从低到高排序好的元素集合，加上withscores，还会返回元素的score值</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrevrange.html">ZREVRANGE</a> <code>ZREVRANGE key start stop [WITHSCORES]</code> 返回指定索引范围内已从高到低排序好的元素集合，加上withscores，还会返回元素的score值</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrangebyscore.html">ZRANGEBYSCORE</a> <code>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrevrangebyscore.html">ZREVRANGEBYSCORE</a> <code>ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrank.html">ZRANK</a> <code>ZRANK key member</code> 返回元素在集合中的排名，从低到高排序，0为顶</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrevrank.html">ZREVRANK</a> <code>ZREVRANK key member</code> 返回元素在集合中的排名，从高到低排序，0为低</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrem.html">ZREM</a> <code>ZREM key member [member …]</code> 删除指定元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zremrangebyrank.html">ZREMRANGEBYRANK</a> <code>ZREMRANGEBYRANK key start stop</code> 删除指定索引范围的所有元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zremrangebyscore.html">ZREMRANGEBYSCORE</a> <code>ZREMRANGEBYSCORE key min max</code> 删除指定score范围内的所有元素</li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zrangebylex.html">ZRANGEBYLEX</a> <code>ZRANGEBYLEX key min max [LIMIT offset count]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zlexcount.html">ZLEXCOUNT</a> <code>ZLEXCOUNT key min max</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zremrangebylex.html">ZREMRANGEBYLEX</a> <code>ZREMRANGEBYLEX key min max</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zscan.html">ZSCAN</a> <code>ZSCAN key cursor [MATCH pattern] [COUNT count]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zunionstore.html">ZUNIONSTORE</a> <code>ZUNIONSTORE destination numkeys key [key …] [WEIGHTS weight [weight …]] [AGGREGATE SUM|MIN|MAX]</code></li>
<li><a target="_blank" rel="noopener" href="http://redisdoc.com/sorted_set/zinterstore.html">ZINTERSTORE</a> <code>ZINTERSTORE destination numkeys key [key …] [WEIGHTS weight [weight …]] [AGGREGATE SUM|MIN|MAX]</code></li>
</ul>
<p>min max 支持开区间（小括号）和闭区间（中括号），-inf和+inf分别代表无限小和无限大</p>
<h3 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h3><ol>
<li>集合内元素不能重复</li>
<li>可以通过给元素设置一个score作为排序的依据，以达到排序效果</li>
</ol>
<h3 id="内部编码-4"><a href="#内部编码-4" class="headerlink" title="内部编码"></a>内部编码</h3><ul>
<li>ziplist（压缩列表）当有序集合的元素个数小于<code>zset-max-ziplist-entries</code>配置（默128个），同时每个元素的值都小于<code>zset-max-ziplist-value</code>配置（默认 64字节）时，Redis会使用ziplist作为有序集合的内部实现，ziplist可以有效减少内存的使用。</li>
<li>skiplist（跳跃表）当ziplist条件不满足时，有序集合会使用skiplist作为内部实现，因为此时ziplist的读写效率会下降。</li>
</ul>
<h3 id="典型应用场景-3"><a href="#典型应用场景-3" class="headerlink" title="典型应用场景"></a>典型应用场景</h3><ol>
<li>排行榜</li>
</ol>
<p>例如视频网站需要对用户上传到视频做排行榜，榜单的维度可能是多个方面：时间、播放量、点赞数等。</p>
<h1 id="三、数据结构"><a href="#三、数据结构" class="headerlink" title="三、数据结构"></a>三、数据结构</h1><h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><p>dictht 是一个散列表结构，使用拉链法解决哈希冲突。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. *&#x2F;
typedef struct dictht &#123;
    dictEntry **table;
    unsigned long size;
    unsigned long sizemask;
    unsigned long used;
&#125; dictht;
typedef struct dictEntry &#123;
    void *key;
    union &#123;
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    &#125; v;
    struct dictEntry *next;
&#125; dictEntry;</code></pre>

<p>Redis 的字典 dict 中包含两个哈希表 dictht，这是为了方便进行 rehash 操作。在扩容时，将其中一个 dictht 上的键值对 rehash 到另一个 dictht 上面，完成之后释放空间并交换两个 dictht 的角色。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">typedef struct dict &#123;
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx; &#x2F;* rehashing not in progress if rehashidx &#x3D;&#x3D; -1 *&#x2F;
    unsigned long iterators; &#x2F;* number of iterators currently running *&#x2F;
&#125; dict;</code></pre>

<p>rehash 操作不是一次性完成，而是采用渐进方式，这是为了避免一次性执行过多的 rehash 操作给服务器带来过大的负担。</p>
<p>渐进式 rehash 通过记录 dict 的 rehashidx 完成，它从 0 开始，然后每执行一次 rehash 都会递增。例如在一次 rehash 中，要把 dict[0] rehash 到 dict[1]，这一次会把 dict[0] 上 table[rehashidx] 的键值对 rehash 到 dict[1] 上，dict[0] 的 table[rehashidx] 指向 null，并令 rehashidx++。</p>
<p>在 rehash 期间，每次对字典执行添加、删除、查找或者更新操作时，都会执行一次渐进式 rehash。</p>
<p>采用渐进式 rehash 会导致字典中的数据分散在两个 dictht 上，因此对字典的查找操作也需要到对应的 dictht 去执行。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* Performs N steps of incremental rehashing. Returns 1 if there are still
 * keys to move from the old to the new hash table, otherwise 0 is returned.
 *
 * Note that a rehashing step consists in moving a bucket (that may have more
 * than one key as we use chaining) from the old to the new hash table, however
 * since part of the hash table may be composed of empty spaces, it is not
 * guaranteed that this function will rehash even a single bucket, since it
 * will visit at max N*10 empty buckets in total, otherwise the amount of
 * work it does would be unbound and the function may block for a long time. *&#x2F;
int dictRehash(dict *d, int n) &#123;
    int empty_visits &#x3D; n * 10; &#x2F;* Max number of empty buckets to visit. *&#x2F;
    if (!dictIsRehashing(d)) return 0;

    while (n-- &amp;&amp; d-&gt;ht[0].used !&#x3D; 0) &#123;
        dictEntry *de, *nextde;

        &#x2F;* Note that rehashidx can&#39;t overflow as we are sure there are more
         * elements because ht[0].used !&#x3D; 0 *&#x2F;
        assert(d-&gt;ht[0].size &gt; (unsigned long) d-&gt;rehashidx);
        while (d-&gt;ht[0].table[d-&gt;rehashidx] &#x3D;&#x3D; NULL) &#123;
            d-&gt;rehashidx++;
            if (--empty_visits &#x3D;&#x3D; 0) return 1;
        &#125;
        de &#x3D; d-&gt;ht[0].table[d-&gt;rehashidx];
        &#x2F;* Move all the keys in this bucket from the old to the new hash HT *&#x2F;
        while (de) &#123;
            uint64_t h;

            nextde &#x3D; de-&gt;next;
            &#x2F;* Get the index in the new hash table *&#x2F;
            h &#x3D; dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[1].sizemask;
            de-&gt;next &#x3D; d-&gt;ht[1].table[h];
            d-&gt;ht[1].table[h] &#x3D; de;
            d-&gt;ht[0].used--;
            d-&gt;ht[1].used++;
            de &#x3D; nextde;
        &#125;
        d-&gt;ht[0].table[d-&gt;rehashidx] &#x3D; NULL;
        d-&gt;rehashidx++;
    &#125;

    &#x2F;* Check if we already rehashed the whole table... *&#x2F;
    if (d-&gt;ht[0].used &#x3D;&#x3D; 0) &#123;
        zfree(d-&gt;ht[0].table);
        d-&gt;ht[0] &#x3D; d-&gt;ht[1];
        _dictReset(&amp;d-&gt;ht[1]);
        d-&gt;rehashidx &#x3D; -1;
        return 0;
    &#125;

    &#x2F;* More to rehash... *&#x2F;
    return 1;
&#125;</code></pre>

<h2 id="跳跃表"><a href="#跳跃表" class="headerlink" title="跳跃表"></a>跳跃表</h2><p>是有序集合的底层实现之一。</p>
<p>跳跃表是基于多指针有序链表实现的，可以看成多个有序链表。</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/beba612e-dc5b-4fc2-869d-0b23408ac90a.png" alt="img"></p>
<p>在查找时，从上层指针开始查找，找到对应的区间之后再到下一层去查找。下图演示了查找 22 的过程。</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/0ea37ee2-c224-4c79-b895-e131c6805c40.png" alt="img"></p>
<p>与红黑树等平衡树相比，跳跃表具有以下优点：</p>
<ul>
<li>插入速度非常快速，因为不需要进行旋转等操作来维护平衡性；</li>
<li>更容易实现；</li>
<li>支持无锁操作。</li>
</ul>
<h1 id="四、使用场景"><a href="#四、使用场景" class="headerlink" title="四、使用场景"></a>四、使用场景</h1><h2 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h2><p>可以对 String 进行自增自减运算，从而实现计数器功能。</p>
<p>Redis 这种内存型数据库的读写性能非常高，很适合存储频繁读写的计数量。</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>将热点数据放到内存中，设置内存的最大使用量以及淘汰策略来保证缓存的命中率。</p>
<h2 id="查找表"><a href="#查找表" class="headerlink" title="查找表"></a>查找表</h2><p>例如 DNS 记录就很适合使用 Redis 进行存储。</p>
<p>查找表和缓存类似，也是利用了 Redis 快速的查找特性。但是查找表的内容不能失效，而缓存的内容可以失效，因为缓存不作为可靠的数据来源。</p>
<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p>List 是一个双向链表，可以通过 lpush 和 rpop 写入和读取消息</p>
<p>不过最好使用 Kafka、RabbitMQ 等消息中间件。</p>
<h2 id="会话缓存"><a href="#会话缓存" class="headerlink" title="会话缓存"></a>会话缓存</h2><p>可以使用 Redis 来统一存储多台应用服务器的会话信息。</p>
<p>当应用服务器不再存储用户的会话信息，也就不再具有状态，一个用户可以请求任意一个应用服务器，从而更容易实现高可用性以及可伸缩性。</p>
<h2 id="分布式锁实现"><a href="#分布式锁实现" class="headerlink" title="分布式锁实现"></a>分布式锁实现</h2><p>在分布式场景下，无法使用单机环境下的锁来对多个节点上的进程进行同步。</p>
<p>可以使用 Redis 自带的 SETNX 命令实现分布式锁，除此之外，还可以使用官方提供的 RedLock 分布式锁实现。</p>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p>Set 可以实现交集、并集等操作，从而实现共同好友等功能。</p>
<p>ZSet 可以实现有序性操作，从而实现排行榜等功能。</p>
<h1 id="五、Redis-与-Memcached"><a href="#五、Redis-与-Memcached" class="headerlink" title="五、Redis 与 Memcached"></a>五、Redis 与 Memcached</h1><p>两者都是非关系型内存键值数据库，主要有以下不同：</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>Memcached 仅支持字符串类型，而 Redis 支持五种不同的数据类型，可以更灵活地解决问题。</p>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>Redis 支持两种持久化策略：RDB 快照和 AOF 日志，而 Memcached 不支持持久化。</p>
<h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2><p>Memcached 不支持分布式，只能通过在客户端使用一致性哈希来实现分布式存储，这种方式在存储和查询时都需要先在客户端计算一次数据所在的节点。</p>
<p>Redis Cluster 实现了分布式的支持。</p>
<h2 id="内存管理机制"><a href="#内存管理机制" class="headerlink" title="内存管理机制"></a>内存管理机制</h2><ul>
<li>在 Redis 中，并不是所有数据都一直存储在内存中，可以将一些很久没用的 value 交换到磁盘，而 Memcached 的数据则会一直在内存中。</li>
<li>Memcached 将内存分割成特定长度的块来存储数据，以完全解决内存碎片的问题。但是这种方式会使得内存的利用率不高，例如块的大小为 128 bytes，只存储 100 bytes 的数据，那么剩下的 28 bytes 就浪费掉了。</li>
</ul>
<h1 id="六、键的过期时间"><a href="#六、键的过期时间" class="headerlink" title="六、键的过期时间"></a>六、键的过期时间</h1><p>Redis 可以为每个键设置过期时间，当键过期时，会自动删除该键。</p>
<p>对于散列表这种容器，只能为整个键设置过期时间（整个散列表），而不能为键里面的单个元素设置过期时间。</p>
<h1 id="七、数据淘汰策略"><a href="#七、数据淘汰策略" class="headerlink" title="七、数据淘汰策略"></a>七、数据淘汰策略</h1><p>可以设置内存最大使用量，当内存使用量超出时，会施行数据淘汰策略。</p>
<p>Redis 具体有 6 种淘汰策略：</p>
<table>
<thead>
<tr>
<th align="center">策略</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">volatile-lru</td>
<td align="center">从已设置过期时间的数据集中挑选最近最少使用的数据淘汰</td>
</tr>
<tr>
<td align="center">volatile-ttl</td>
<td align="center">从已设置过期时间的数据集中挑选将要过期的数据淘汰</td>
</tr>
<tr>
<td align="center">volatile-random</td>
<td align="center">从已设置过期时间的数据集中任意选择数据淘汰</td>
</tr>
<tr>
<td align="center">allkeys-lru</td>
<td align="center">从所有数据集中挑选最近最少使用的数据淘汰</td>
</tr>
<tr>
<td align="center">allkeys-random</td>
<td align="center">从所有数据集中任意选择数据进行淘汰</td>
</tr>
<tr>
<td align="center">noeviction</td>
<td align="center">禁止驱逐数据</td>
</tr>
</tbody></table>
<p>作为内存数据库，出于对性能和内存消耗的考虑，Redis 的淘汰算法实际实现上并非针对所有 key，而是抽样一小部分并且从中选出被淘汰的 key。</p>
<p>使用 Redis 缓存数据时，为了提高缓存命中率，需要保证缓存数据都是热点数据。可以将内存最大使用量设置为热点数据占用的内存量，然后启用 allkeys-lru 淘汰策略，将最近最少使用的数据淘汰。</p>
<p>Redis 4.0 引入了 volatile-lfu 和 allkeys-lfu 淘汰策略，LFU 策略通过统计访问频率，将访问频率最少的键值对淘汰。</p>
<h1 id="八、持久化"><a href="#八、持久化" class="headerlink" title="八、持久化"></a>八、持久化</h1><p>Redis 是内存型数据库，为了保证数据在断电后不会丢失，需要将内存中的数据持久化到硬盘上。</p>
<h2 id="RDB-持久化"><a href="#RDB-持久化" class="headerlink" title="RDB 持久化"></a>RDB 持久化</h2><p>将某个时间点的所有数据都存放到硬盘上。</p>
<p>可以将快照复制到其它服务器从而创建具有相同数据的服务器副本。</p>
<p>如果系统发生故障，将会丢失最后一次创建快照之后的数据。</p>
<p>如果数据量很大，保存快照的时间会很长。</p>
<h2 id="AOF-持久化"><a href="#AOF-持久化" class="headerlink" title="AOF 持久化"></a>AOF 持久化</h2><p>将写命令添加到 AOF 文件（Append Only File）的末尾。</p>
<p>使用 AOF 持久化需要设置同步选项，从而确保写命令同步到磁盘文件上的时机。这是因为对文件进行写入并不会马上将内容同步到磁盘上，而是先存储到缓冲区，然后由操作系统决定什么时候同步到磁盘。有以下同步选项：</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">同步频率</th>
</tr>
</thead>
<tbody><tr>
<td align="center">always</td>
<td align="center">每个写命令都同步</td>
</tr>
<tr>
<td align="center">everysec</td>
<td align="center">每秒同步一次</td>
</tr>
<tr>
<td align="center">no</td>
<td align="center">让操作系统来决定何时同步</td>
</tr>
</tbody></table>
<ul>
<li>always 选项会严重减低服务器的性能；</li>
<li>everysec 选项比较合适，可以保证系统崩溃时只会丢失一秒左右的数据，并且 Redis 每秒执行一次同步对服务器性能几乎没有任何影响；</li>
<li>no 选项并不能给服务器性能带来多大的提升，而且也会增加系统崩溃时数据丢失的数量。</li>
</ul>
<p>随着服务器写请求的增多，AOF 文件会越来越大。Redis 提供了一种将 AOF 重写的特性，能够去除 AOF 文件中的冗余写命令。</p>
<h1 id="九、事务"><a href="#九、事务" class="headerlink" title="九、事务"></a>九、事务</h1><p>一个事务包含了多个命令，服务器在执行事务期间，不会改去执行其它客户端的命令请求。</p>
<p>事务中的多个命令被一次性发送给服务器，而不是一条一条发送，这种方式被称为流水线，它可以减少客户端与服务器之间的网络通信次数从而提升性能。</p>
<p>Redis 最简单的事务实现方式是使用 MULTI 和 EXEC 命令将事务操作包围起来。</p>
<h1 id="十、事件"><a href="#十、事件" class="headerlink" title="十、事件"></a>十、事件</h1><p>Redis 服务器是一个事件驱动程序。</p>
<h2 id="文件事件"><a href="#文件事件" class="headerlink" title="文件事件"></a>文件事件</h2><p>服务器通过套接字与客户端或者其它服务器进行通信，文件事件就是对套接字操作的抽象。</p>
<p>Redis 基于 Reactor 模式开发了自己的网络事件处理器，使用 I/O 多路复用程序来同时监听多个套接字，并将到达的事件传送给文件事件分派器，分派器会根据套接字产生的事件类型调用相应的事件处理器。</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9ea86eb5-000a-4281-b948-7b567bd6f1d8.png" alt="img"></p>
<h2 id="时间事件"><a href="#时间事件" class="headerlink" title="时间事件"></a>时间事件</h2><p>服务器有一些操作需要在给定的时间点执行，时间事件是对这类定时操作的抽象。</p>
<p>时间事件又分为：</p>
<ul>
<li>定时事件：是让一段程序在指定的时间之内执行一次；</li>
<li>周期性事件：是让一段程序每隔指定时间就执行一次。</li>
</ul>
<p>Redis 将所有时间事件都放在一个无序链表中，通过遍历整个链表查找出已到达的时间事件，并调用相应的事件处理器。</p>
<h2 id="事件的调度与执行"><a href="#事件的调度与执行" class="headerlink" title="事件的调度与执行"></a>事件的调度与执行</h2><p>服务器需要不断监听文件事件的套接字才能得到待处理的文件事件，但是不能一直监听，否则时间事件无法在规定的时间内执行，因此监听时间应该根据距离现在最近的时间事件来决定。</p>
<p>事件调度与执行由 aeProcessEvents 函数负责，伪代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">def aeProcessEvents():
    # 获取到达时间离当前时间最接近的时间事件
    time_event &#x3D; aeSearchNearestTimer()
    # 计算最接近的时间事件距离到达还有多少毫秒
    remaind_ms &#x3D; time_event.when - unix_ts_now()
    # 如果事件已到达，那么 remaind_ms 的值可能为负数，将它设为 0
    if remaind_ms &lt; 0:
        remaind_ms &#x3D; 0
    # 根据 remaind_ms 的值，创建 timeval
    timeval &#x3D; create_timeval_with_ms(remaind_ms)
    # 阻塞并等待文件事件产生，最大阻塞时间由传入的 timeval 决定
    aeApiPoll(timeval)
    # 处理所有已产生的文件事件
    procesFileEvents()
    # 处理所有已到达的时间事件
    processTimeEvents()</code></pre>

<p>将 aeProcessEvents 函数置于一个循环里面，加上初始化和清理函数，就构成了 Redis 服务器的主函数，伪代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">def main():
    # 初始化服务器
    init_server()
    # 一直处理事件，直到服务器关闭为止
    while server_is_not_shutdown():
        aeProcessEvents()
    # 服务器关闭，执行清理操作
    clean_server()</code></pre>

<p>从事件处理的角度来看，服务器运行流程如下：</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/c0a9fa91-da2e-4892-8c9f-80206a6f7047.png" alt="img"></p>
<h1 id="十一、复制"><a href="#十一、复制" class="headerlink" title="十一、复制"></a>十一、复制</h1><p>通过使用 slaveof host port 命令来让一个服务器成为另一个服务器的从服务器。</p>
<p>一个从服务器只能有一个主服务器，并且不支持主主复制。</p>
<h2 id="连接过程"><a href="#连接过程" class="headerlink" title="连接过程"></a>连接过程</h2><ol>
<li>主服务器创建快照文件，发送给从服务器，并在发送期间使用缓冲区记录执行的写命令。快照文件发送完毕之后，开始向从服务器发送存储在缓冲区中的写命令；</li>
<li>从服务器丢弃所有旧数据，载入主服务器发来的快照文件，之后从服务器开始接受主服务器发来的写命令；</li>
<li>主服务器每执行一次写命令，就向从服务器发送相同的写命令。</li>
</ol>
<h2 id="主从链"><a href="#主从链" class="headerlink" title="主从链"></a>主从链</h2><p>随着负载不断上升，主服务器可能无法很快地更新所有从服务器，或者重新连接和重新同步从服务器将导致系统超载。为了解决这个问题，可以创建一个中间层来分担主服务器的复制工作。中间层的服务器是最上层服务器的从服务器，又是最下层服务器的主服务器。</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/395a9e83-b1a1-4a1d-b170-d081e7bb5bab.png" alt="img"></p>
<h1 id="十二、Sentinel"><a href="#十二、Sentinel" class="headerlink" title="十二、Sentinel"></a>十二、Sentinel</h1><p>Sentinel（哨兵）可以监听集群中的服务器，并在主服务器进入下线状态时，自动从从服务器中选举出新的主服务器。</p>
<h1 id="十三、分片"><a href="#十三、分片" class="headerlink" title="十三、分片"></a>十三、分片</h1><p>分片是将数据划分为多个部分的方法，可以将数据存储到多台机器里面，这种方法在解决某些问题时可以获得线性级别的性能提升。</p>
<p>假设有 4 个 Redis 实例 R0，R1，R2，R3，还有很多表示用户的键 user:1，user:2，... ，有不同的方式来选择一个指定的键存储在哪个实例中。</p>
<ul>
<li>最简单的方式是范围分片，例如用户 id 从 0<del>1000 的存储到实例 R0 中，用户 id 从 1001</del>2000 的存储到实例 R1 中，等等。但是这样需要维护一张映射范围表，维护操作代价很高。</li>
<li>还有一种方式是哈希分片，使用 CRC32 哈希函数将键转换为一个数字，再对实例数量求模就能知道应该存储的实例。</li>
</ul>
<p>根据执行分片的位置，可以分为三种分片方式：</p>
<ul>
<li>客户端分片：客户端使用一致性哈希等算法决定键应当分布到哪个节点。</li>
<li>代理分片：将客户端请求发送到代理上，由代理转发请求到正确的节点上。</li>
<li>服务器分片：Redis Cluster。</li>
</ul>
<h1 id="十四、一个简单的论坛系统分析"><a href="#十四、一个简单的论坛系统分析" class="headerlink" title="十四、一个简单的论坛系统分析"></a>十四、一个简单的论坛系统分析</h1><p>该论坛系统功能如下：</p>
<ul>
<li>可以发布文章；</li>
<li>可以对文章进行点赞；</li>
<li>在首页可以按文章的发布时间或者文章的点赞数进行排序显示。</li>
</ul>
<h2 id="文章信息"><a href="#文章信息" class="headerlink" title="文章信息"></a>文章信息</h2><p>文章包括标题、作者、赞数等信息，在关系型数据库中很容易构建一张表来存储这些信息，在 Redis 中可以使用 HASH 来存储每种信息以及其对应的值的映射。</p>
<p>Redis 没有关系型数据库中的表这一概念来将同种类型的数据存放在一起，而是使用命名空间的方式来实现这一功能。键名的前面部分存储命名空间，后面部分的内容存储 ID，通常使用 : 来进行分隔。例如下面的 HASH 的键名为 article:92617，其中 article 为命名空间，ID 为 92617。</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7c54de21-e2ff-402e-bc42-4037de1c1592.png" alt="img"></p>
<h2 id="点赞功能"><a href="#点赞功能" class="headerlink" title="点赞功能"></a>点赞功能</h2><p>当有用户为一篇文章点赞时，除了要对该文章的 votes 字段进行加 1 操作，还必须记录该用户已经对该文章进行了点赞，防止用户点赞次数超过 1。可以建立文章的已投票用户集合来进行记录。</p>
<p>为了节约内存，规定一篇文章发布满一周之后，就不能再对它进行投票，而文章的已投票集合也会被删除，可以为文章的已投票集合设置一个一周的过期时间就能实现这个规定。</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/485fdf34-ccf8-4185-97c6-17374ee719a0.png" alt="img"></p>
<h2 id="对文章进行排序"><a href="#对文章进行排序" class="headerlink" title="对文章进行排序"></a>对文章进行排序</h2><p>为了按发布时间和点赞数进行排序，可以建立一个文章发布时间的有序集合和一个文章点赞数的有序集合。（下图中的 score 就是这里所说的点赞数；下面所示的有序集合分值并不直接是时间和点赞数，而是根据时间和点赞数间接计算出来的）</p>
<p><img data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/f7d170a3-e446-4a64-ac2d-cb95028f81a8.png" alt="img"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>Carlson J L. Redis in Action[J]. Media.johnwiley.com.au, 2013.</li>
<li>[黄健宏. Redis 设计与实现 <a target="_blank" rel="noopener" href="http://redisbook.com/index.html">M]. 机械工业出版社, 2014.(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://redislabs.com/ebook/foreword/">REDIS IN ACTION(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="http://ticki.github.io/blog/skip-lists-done-right/">Skip Lists: Done Right(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/loveincode/p/7411911.html">论述 Redis 和 Memcached 的差异(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/redis-guide">Redis 3.0 中文版- 分片(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.scienjus.com/redis-use-case/">Redis 应用场景(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/lru-cache">Using Redis as an LRU cache</a></li>
</ul>

      </div>
      
      
      
    </div>

    
    


</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JIAHE</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js" integrity="sha256-2N+3bVl+vOCJyZ9ZbH9Eb99XKT/53oT5V8eRbB8bFcA=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-33Qw0lN3qo7tLZL4c7vDLCapRUs+gNtQRaVIOHk4Ors=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha256-jWSJB6Iusw1nLB+Iqwk0dp9T2jSn5bRzLXJCE1VmOIU=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>



  <script class="next-config" data-name="pdf" type="application/json">{&quot;object_url&quot;:{&quot;url&quot;:&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;pdfobject@2.2.5&#x2F;pdfobject.min.js&quot;,&quot;integrity&quot;:&quot;sha256-YuNlP9i6s&#x2F;WH7EaU2kErloo9Vc85C3WVqhoMDgsEVpY&#x3D;&quot;},&quot;url&quot;:&quot;&#x2F;lib&#x2F;pdf&#x2F;web&#x2F;viewer.html&quot;}</script>
  <script src="/js/third-party/tags/pdf.js"></script>



  




  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.1.0/dist/quicklink.umd.js" integrity="sha256-KK3rvmDcW72MSl9jzzNZWlQjZNrRzAuGhAQ+0SFOg7Q=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{&quot;enable&quot;:true,&quot;home&quot;:true,&quot;archive&quot;:true,&quot;delay&quot;:true,&quot;timeout&quot;:3000,&quot;priority&quot;:true,&quot;ignores&quot;:null,&quot;url&quot;:&quot;https:&#x2F;&#x2F;xiaojianzheng.cn&#x2F;database&#x2F;redis.html&quot;}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
