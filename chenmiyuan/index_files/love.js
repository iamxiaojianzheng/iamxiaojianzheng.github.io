!function(t){function e(t,e){return t+Math.floor(Math.random()*(e-t+1))}function o(t,e){var i=t[0].mul((1-e)*(1-e)),o=t[1].mul(2*e*(1-e)),n=t[2].mul(e*e);return i.add(o).add(n)}function n(t,e,i){return(t/i*(t/i)+e/i*(e/i)-1)*(t/i*(t/i)+e/i*(e/i)-1)*(t/i*(t/i)+e/i*(e/i)-1)-t/i*(t/i)*(e/i)*(e/i)*(e/i)<0}Point=function(t,e){this.x=t||0,this.y=e||0},Point.prototype={clone:function(){return new Point(this.x,this.y)},add:function(t){return p=this.clone(),p.x+=t.x,p.y+=t.y,p},sub:function(t){return p=this.clone(),p.x-=t.x,p.y-=t.y,p},div:function(t){return p=this.clone(),p.x/=t,p.y/=t,p},mul:function(t){return p=this.clone(),p.x*=t,p.y*=t,p}},Heart=function(){for(
// x = 16 sin^3 t
// y = 13 cos t - 5 cos 2t - 2 cos 3t - cos 4t
// http://www.wolframalpha.com/input/?i=x+%3D+16+sin%5E3+t%2C+y+%3D+(13+cos+t+-+5+cos+2t+-+2+cos+3t+-+cos+4t)
var t,e,i,o=[],n=10;n<30;n+=.2)i=n/Math.PI,t=16*Math.pow(Math.sin(i),3),e=13*Math.cos(i)-5*Math.cos(2*i)-2*Math.cos(3*i)-Math.cos(4*i),o.push(new Point(t,e));this.points=o,this.length=o.length},Heart.prototype={get:function(t,e){return this.points[t].mul(e||1)}},Seed=function(t,e,i,o){this.tree=t;i=i||1,o=o||"#FF0000";this.heart={point:e,scale:i,color:o,figure:new Heart},this.cirle={point:e,scale:i,color:o,radius:5}},Seed.prototype={draw:function(){this.drawHeart(),this.drawText()},addPosition:function(t,e){this.cirle.point=this.cirle.point.add(new Point(t,e))},canMove:function(){return this.cirle.point.y<this.tree.height+20},move:function(t,e){this.clear(),this.drawCirle(),this.addPosition(t,e)},canScale:function(){return this.heart.scale>.2},setHeartScale:function(t){this.heart.scale*=t},scale:function(t){this.clear(),this.drawCirle(),this.drawHeart(),this.setHeartScale(t)},drawHeart:function(){var t=this.tree.ctx,e=this.heart,i=e.point,o=e.color,n=e.scale;t.save(),t.fillStyle=o,t.translate(i.x,i.y),t.beginPath(),t.moveTo(0,0);for(var r=0;r<e.figure.length;r++){var h=e.figure.get(r,n);t.lineTo(h.x,-h.y)}t.closePath(),t.fill(),t.restore()},drawCirle:function(){var t=this.tree.ctx,e=this.cirle,i=e.point,o=e.color,n=e.scale,r=e.radius;t.save(),t.fillStyle=o,t.translate(i.x,i.y),t.scale(n,n),t.beginPath(),t.moveTo(0,0),t.arc(0,0,r,0,2*Math.PI),t.closePath(),t.fill(),t.restore()},drawText:function(){var t=this.tree.ctx,e=this.heart,i=e.point,o=e.color,n=e.scale;t.save(),t.strokeStyle=o,t.fillStyle=o,t.translate(i.x,i.y),t.scale(n,n),t.moveTo(0,0),t.lineTo(15,15),t.lineTo(60,15),t.stroke(),t.moveTo(0,0),t.scale(.75,.75),t.font="12px 微软雅黑,Verdana",// 字号肿么没有用? (ˉ(∞)ˉ)
t.fillText("click here",23,16),t.restore()},clear:function(){var t=this.tree.ctx,e=this.cirle,i=e.point,o=e.scale,n=h=26*o;t.clearRect(i.x-n,i.y-h,4*n,4*h)},hover:function(t,e){return 255==this.tree.ctx.getImageData(t,e,1,1).data[3]}},Footer=function(t,e,i,o){this.tree=t,this.point=new Point(t.seed.heart.point.x,t.height-i/2),this.width=e,this.height=i,this.speed=o||2,this.length=0},Footer.prototype={draw:function(){var t=this.tree.ctx,e=this.point,i=this.length/2;t.save(),t.strokeStyle="rgb(35, 31, 32)",t.lineWidth=this.height,t.lineCap="round",t.lineJoin="round",t.translate(e.x,e.y),t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.lineTo(-i,0),t.stroke(),t.restore(),this.length<this.width&&(this.length+=this.speed)}},Tree=function(t,e,i,o){this.canvas=t,this.ctx=t.getContext("2d"),this.width=e,this.height=i,this.opt=o||{},this.record={},this.initSeed(),this.initFooter(),this.initBranch(),this.initBloom()},Tree.prototype={initSeed:function(){var t=this.opt.seed||{},e=t.x||this.width/2,i=t.y||this.height/2,o=new Point(e,i),n=t.color||"#FF0000",r=t.scale||1;this.seed=new Seed(this,o,r,n)},initFooter:function(){var t=this.opt.footer||{},e=t.width||this.width,i=t.height||5,o=t.speed||2;this.footer=new Footer(this,e,i,o)},initBranch:function(){var t=this.opt.branch||[];this.branchs=[],this.addBranchs(t)},initBloom:function(){for(var t=this.opt.bloom||{},e=[],i=t.num||500,o=t.width||this.width,n=t.height||this.height,r=this.seed.heart.figure,h=0;h<i;h++)e.push(this.createBloom(o,n,240,r));this.blooms=[],this.bloomsCache=e},toDataURL:function(t){return this.canvas.toDataURL(t)},draw:function(t){var e=this.ctx,i=this.record[t];if(i){var o=i.point,n=i.image;e.save(),e.putImageData(n,o.x,o.y),e.restore()}},addBranch:function(t){this.branchs.push(t)},addBranchs:function(t){for(var e,i,o,n,r,h,s,a=0;a<t.length;a++)e=t[a],i=new Point(e[0],e[1]),o=new Point(e[2],e[3]),n=new Point(e[4],e[5]),r=e[6],h=e[7],s=e[8],this.addBranch(new Branch(this,i,o,n,r,h,s))},removeBranch:function(t){for(var e=this.branchs,i=0;i<e.length;i++)e[i]===t&&e.splice(i,1)},canGrow:function(){return!!this.branchs.length},grow:function(){for(var t=this.branchs,e=0;e<t.length;e++){var i=t[e];i&&i.grow()}},addBloom:function(t){this.blooms.push(t)},removeBloom:function(t){for(var e=this.blooms,i=0;i<e.length;i++)e[i]===t&&e.splice(i,1)},createBloom:function(t,i,o,r,h,s,a,l,c,u){for(var p,d;;)if(n((p=e(20,t-20))-t/2,i-(i-40)/2-(d=e(20,i-20)),o))return new Bloom(this,new Point(p,d),r,h,s,a,l,c,u)},canFlower:function(){return!!this.blooms.length},flower:function(t){for(var e=this,i=e.bloomsCache.splice(0,t),o=0;o<i.length;o++)e.addBloom(i[o]);i=e.blooms;for(var n=0;n<i.length;n++)i[n].flower()},snapshot:function(t,e,i,o,n){var r=this.ctx.getImageData(e,i,o,n);this.record[t]={image:r,point:new Point(e,i),width:o,height:n}},setSpeed:function(t,e){this.record[t||"move"].speed=e},move:function(t,e,o){var n=this.ctx,r=this.record[t||"move"],h=r.point,s=r.image,a=r.speed||10,l=r.width,c=r.height;return i=h.x+a<e?h.x+a:e,j=h.y+a<o?h.y+a:o,n.save(),n.clearRect(h.x,h.y,l,c),n.putImageData(s,i,j),n.restore(),r.point=new Point(i,j),r.speed=.95*a,r.speed<2&&(r.speed=2),i<e||j<o},jump:function(){var t=this.blooms;if(t.length)for(var i=0;i<t.length;i++)t[i].jump();if(t.length&&t.length<3||!t.length){var o=this.opt.bloom||{},n=o.width||this.width,r=o.height||this.height,h=this.seed.heart.figure;for(i=0;i<e(1,2);i++)t.push(this.createBloom(n/2+n,r,240,h,null,1,null,1,new Point(e(-100,600),720),e(200,300)))}}},Branch=function(t,e,i,o,n,r,h){this.tree=t,this.point1=e,this.point2=i,this.point3=o,this.radius=n,this.length=r||100,this.len=0,this.t=1/(this.length-1),this.branchs=h||[]},Branch.prototype={grow:function(){var t,e=this;e.len<=e.length?(t=o([e.point1,e.point2,e.point3],e.len*e.t),e.draw(t),e.len+=1,e.radius*=.97):(e.tree.removeBranch(e),e.tree.addBranchs(e.branchs))},draw:function(t){var e=this.tree.ctx;e.save(),e.beginPath(),e.fillStyle="rgb(35, 31, 32)",e.shadowColor="rgb(35, 31, 32)",e.shadowBlur=2,e.moveTo(t.x,t.y),e.arc(t.x,t.y,this.radius,0,2*Math.PI),e.closePath(),e.fill(),e.restore()}},Bloom=function(t,i,o,n,r,h,s,a,l){this.tree=t,this.point=i,this.color=n||"rgb(255,"+e(0,255)+","+e(0,255)+")",this.alpha=r||e(.3,1),this.angle=h||e(0,360),this.scale=s||.1,this.place=a,this.speed=l,this.figure=o},Bloom.prototype={setFigure:function(t){this.figure=t},flower:function(){var t=this;t.draw(),t.scale+=.1,t.scale>1&&t.tree.removeBloom(t)},draw:function(){var t=this,e=t.tree.ctx,i=t.figure;e.save(),e.fillStyle=t.color,e.globalAlpha=t.alpha,e.translate(t.point.x,t.point.y),e.scale(t.scale,t.scale),e.rotate(t.angle),e.beginPath(),e.moveTo(0,0);for(var o=0;o<i.length;o++){var n=i.get(o);e.lineTo(n.x,-n.y)}e.closePath(),e.fill(),e.restore()},jump:function(){var t=this,e=t.tree.height;t.point.x<-20||t.point.y>e+20?t.tree.removeBloom(t):(t.draw(),t.point=t.place.sub(t.point).div(t.speed).add(t.point),t.angle+=.05,t.speed-=1)}},t.random=e,t.bezier=o,t.Point=Point,t.Tree=Tree}(window);